<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Study Game Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
        // ============================================
        // SYSTÈME DE SAUVEGARDE LOCALSTORAGE
        // ============================================
        
        // Variable globale pour toutes les données
        let appData = {
            level: 1,
            xp: 0,
            total_xp: 0,
            energy: 100,
            coins: 0,
            streak: 0,
            rank: "Bronze",
            title: "Étudiant Débutant",
            combo_days: 0,
            subjects: [],
            matieres: {},
            fiches: {},
            sessions: [],
            quiz: [],
            quiz_history: [],
            achievements: [],
            badges: [],
            settings: {
                theme: "dark",
                sounds: true
            }
        };
        
        // Sauvegarder dans localStorage
        function saveData() {
            try {
                localStorage.setItem('studyGameData', JSON.stringify(appData));
                console.log('✅ Données sauvegardées');
                return true;
            } catch (error) {
                console.error('❌ Erreur sauvegarde:', error);
                return false;
            }
        }
        
        // Charger depuis localStorage
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('studyGameData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                    console.log('✅ Données chargées depuis localStorage');
                    return true;
                } else {
                    console.log('ℹ️ Nouvelles données créées');
                    saveData();
                    return false;
                }
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                return false;
            }
        }
        
        // Mock de pywebview.api pour compatibilité
        const pywebview = {
            api: {
                get_data: async () => {
                    loadDataFromStorage();
                    return appData;
                },
                save_session: async (matiere, duration, xp) => {
                    if (!appData.sessions) appData.sessions = [];
                    appData.sessions.push({
                        matiere: matiere,
                        duration: duration,
                        xp: xp,
                        date: new Date().toISOString()
                    });
                    appData.total_xp = (appData.total_xp || 0) + xp;
                    if (!appData.matieres[matiere]) {
                        appData.matieres[matiere] = { xp: 0, temps_total: 0 };
                    }
                    appData.matieres[matiere].xp += xp;
                    appData.matieres[matiere].temps_total += duration;
                    saveData();
                    return { success: true };
                },
                save_fiche: async (matiere, titre, contenu) => {
                    if (!appData.fiches[matiere]) {
                        appData.fiches[matiere] = [];
                    }
                    appData.fiches[matiere].push({
                        titre: titre,
                        contenu: contenu,
                        date: new Date().toISOString()
                    });
                    saveData();
                    return { success: true };
                },
                get_fiches: async (matiere) => {
                    return appData.fiches[matiere] || [];
                },
                save_quiz: async (score, total) => {
                    if (!appData.quiz) appData.quiz = [];
                    appData.quiz.push({
                        score: score,
                        total: total,
                        date: new Date().toISOString()
                    });
                    saveData();
                    return { success: true };
                },
                update_settings: async (theme, sounds) => {
                    if (!appData.settings) appData.settings = {};
                    if (theme !== null) appData.settings.theme = theme;
                    if (sounds !== undefined) appData.settings.sounds = sounds;
                    saveData();
                    return { success: true };
                },
                backup_data: async () => {
                    const dataStr = JSON.stringify(appData, null, 2);
                    const blob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    return { success: true };
                },
                export_data: async () => {
                    return appData;
                }
            }
        };
        
        // Charger au démarrage
        window.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
        });
</script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX pour les mathématiques -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-blue-hover: #79c0ff;
            --accent-green: #238636;
            --accent-green-hover: #2ea043;
            --accent-red: #da3633;
            --accent-yellow: #d29922;
            --accent-orange: #f97316;
            --glass-bg: rgba(22, 27, 34, 0.7);
            --glass-border: rgba(48, 54, 61, 0.5);
        }
        
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --border-color: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
        }
        
        [data-theme="nord"] {
            --bg-primary: #2e3440;
            --bg-secondary: #3b4252;
            --bg-tertiary: #434c5e;
            --border-color: #4c566a;
            --text-primary: #eceff4;
            --text-secondary: #d8dee9;
            --accent-blue: #88c0d0;
            --accent-green: #a3be8c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Cacher les barres de défilement */
        *::-webkit-scrollbar {
            width: 0px;
            height: 0px;
            background: transparent;
        }
        
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        
        
        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--accent-blue), 0 0 10px var(--accent-blue); }
            50% { box-shadow: 0 0 20px var(--accent-blue), 0 0 30px var(--accent-blue); }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes countUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(-45deg, #0d1117, #161b22, #1a1f2e, #0d1117);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(88, 166, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(88, 166, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(22, 27, 34, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(48, 54, 61, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            overflow-y: auto;
            animation: slideIn 0.5s ease;
            transition: all 0.3s ease;
        }
        
        .sidebar:hover {
            background: rgba(22, 27, 34, 0.95);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 10px var(--accent-blue));
        }
        
        .user-profile {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
        }
        
        .user-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }
        
        .user-level {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .combo-display {
            background: var(--accent-blue);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .combo-days {
            font-size: 24px;
            font-weight: 800;
            color: white;
        }
        
        .combo-label {
            font-size: 12px;
            color: white;
            opacity: 0.9;
        }
        
        .nav-item {
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(88, 166, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .nav-item:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .nav-item:hover {
            background: rgba(88, 166, 255, 0.1);
            color: var(--text-primary);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.15);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(88, 166, 255, 0.4);
            transform: translateX(0);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }
        
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            animation: fadeIn 0.5s ease;
        }
        
        .main-content.focus-mode {
            padding: 0;
        }
        
        .focus-mode-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--accent-blue);
        }
        
        .focus-timer {
            text-align: center;
            color: white;
        }
        
        .focus-timer-display {
            font-size: 120px;
            font-weight: 900;
            margin: 40px 0;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .focus-exit {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 24px;
            background: rgba(218, 54, 51, 0.9);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10000;
        }
        
        .focus-exit:hover {
            background: rgba(218, 54, 51, 1);
            transform: scale(1.05);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--accent-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(88, 166, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(88, 166, 255, 0.25), 
                        0 0 0 1px rgba(88, 166, 255, 0.1);
            background: rgba(22, 27, 34, 0.8);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-blue);
        }
        
        .matiere-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .matiere-card {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .matiere-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-blue));
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .matiere-card:hover::before {
            opacity: 1;
        }
        
        .matiere-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-8px) rotateX(5deg);
            box-shadow: 0 20px 40px rgba(88, 166, 255, 0.3),
                        0 0 0 1px rgba(88, 166, 255, 0.1);
            background: rgba(22, 27, 34, 0.8);
        }
        
        .matiere-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--accent-blue);
        }
        
        .matiere-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .matiere-stat:last-child {
            border-bottom: none;
        }
        
        .matiere-stat span:first-child {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .matiere-stat span:last-child {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .session-list {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .session-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .session-item:hover {
            background: var(--bg-tertiary);
            border-radius: 8px;
            transform: translateX(5px);
        }
        
        .session-item:last-child {
            border-bottom: none;
        }
        
        .timer-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .timer-display {
            font-size: 72px;
            font-weight: 800;
            text-align: center;
            margin: 32px 0;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover), var(--accent-green));
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 30px rgba(88, 166, 255, 0.5));
            position: relative;
        }
        
        .timer-display::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            border-radius: 2px;
            animation: pulse 2s ease infinite;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .preset-btn {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
        }
        
        .preset-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-green-hover));
            color: white;
            box-shadow: 0 4px 16px rgba(35, 134, 54, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-green-hover), var(--accent-green));
            box-shadow: 0 6px 24px rgba(35, 134, 54, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
            box-shadow: 0 6px 20px rgba(88, 166, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #e5534b);
            color: white;
            box-shadow: 0 4px 16px rgba(218, 54, 51, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e5534b, var(--accent-red));
            box-shadow: 0 6px 24px rgba(218, 54, 51, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
            color: white;
            box-shadow: 0 4px 16px rgba(88, 166, 255, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, var(--accent-blue-hover), var(--accent-blue));
            box-shadow: 0 6px 24px rgba(88, 166, 255, 0.5);
            transform: translateY(-2px);
            animation: glow 2s ease infinite;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 12px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-direction: column;
            font-size: 14px;
            position: relative;
        }
        
        .calendar-day:hover {
            border-color: var(--accent-blue);
            transform: scale(1.05);
        }
        
        .calendar-day.has-session {
            background: var(--accent-blue);
            color: white;
        }
        
        .calendar-day.important-date {
            border: 2px solid var(--accent-red);
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .achievement-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: start;
            gap: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .achievement-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(88, 166, 255, 0.2);
        }
        
        .achievement-icon {
            font-size: 32px;
        }
        
        .achievement-content h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .achievement-content p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .badge-card {
            background: var(--accent-blue);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
        }
        
        .badge-card.silver {
            background: var(--accent-blue);
        }
        
        .badge-card.gold {
            background: var(--accent-blue);
        }
        
        .badge-card.platinum {
            background: var(--accent-blue);
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(88, 166, 255, 0.1);
            opacity: 0;
            transform: translateY(-20px) translateX(400px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            max-width: 400px;
            animation: slideInUp 0.5s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0) translateX(0);
        }
        
        .notification.success {
            border-color: var(--accent-green);
            box-shadow: 0 8px 32px rgba(35, 134, 54, 0.4);
        }
        
        .notification.error {
            border-color: var(--accent-red);
            box-shadow: 0 8px 32px rgba(218, 54, 51, 0.4);
        }
        
        .method-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .method-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(88, 166, 255, 0.2);
        }
        
        .method-card h3 {
            color: var(--accent-blue);
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .method-card p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .method-card ul {
            color: var(--text-secondary);
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .flash-info {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
        }
        
        .flash-info h2 {
            color: var(--accent-blue);
        }
        
        .flash-info h2 {
            margin-bottom: 16px;
        }
        
        .fiches-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .matiere-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .matiere-btn {
            padding: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .matiere-btn:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .matiere-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .groupes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .groupe-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .groupe-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .groupe-card.favorite::before {
            content: "⭐";
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 20px;
        }
        
        .groupe-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .groupe-info {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .tag {
            background: var(--accent-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .image-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .image-info {
            padding: 12px;
        }
        
        .image-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .image-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .text-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .text-card:hover {
            border-color: var(--accent-blue);
        }
        
        .text-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .text-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            margin: 20px;
        }
        
        .modal-content img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
        }
        
        .back-btn {
            margin-bottom: 24px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: var(--accent-blue);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .file-input-label:hover {
            background: var(--accent-blue-hover);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .delete-btn {
            padding: 8px 16px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #e5534b;
        }
        
        .objective-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .objective-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .objective-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .objective-desc {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 28px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 8px;
            border: 1px solid rgba(48, 54, 61, 0.5);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-blue-hover), var(--accent-green));
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 13px;
            position: relative;
            box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: shimmer 2s infinite;
        }
        
        .quest-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .quest-card.completed {
            opacity: 0.6;
        }
        
        .quest-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-blue);
        }
        
        .quest-reward {
            display: inline-block;
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .chart-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        .settings-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .settings-section h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle.active {
            background: var(--accent-green);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .toggle.active::after {
            left: 33px;
        }
        
        .theme-selector {
            display: flex;
            gap: 12px;
        }
        
        .theme-btn {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .theme-btn.active {
            border-color: var(--accent-blue);
            background: var(--accent-blue);
            color: white;
        }
        
        .quote-card {
            background: var(--accent-blue);
            border-radius: 12px;
            padding: 32px;
            color: white;
            text-align: center;
            margin-bottom: 24px;
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
        }
        

        /* MARKDOWN RENDERING */
        .markdown-content {
            color: var(--text-primary);
            line-height: 1.8;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: var(--accent-blue);
            margin-top: 24px;
            margin-bottom: 12px;
        }
        
        .markdown-content h1 { font-size: 28px; }
        .markdown-content h2 { font-size: 24px; }
        .markdown-content h3 { font-size: 20px; }
        
        .markdown-content p {
            margin-bottom: 16px;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-left: 24px;
            margin-bottom: 16px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
        }
        
        .markdown-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: var(--accent-yellow);
        }
        
        .markdown-content pre {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 16px;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-blue);
            padding-left: 16px;
            margin-left: 0;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }
        
        .markdown-content a {
            color: var(--accent-blue);
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
        
        .markdown-content strong {
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        /* Styles KaTeX personnalisés */
        .markdown-content .katex {
            font-size: 1.1em;
        }
        
        .markdown-content .katex-display {
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        /* Tableaux */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        
        .markdown-content th {
            background: var(--bg-secondary);
            font-weight: 700;
        }
        
        .markdown-content tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        
        /* Images dans le markdown */
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }
        

        /* MOBILE HAMBURGER MENU */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .hamburger:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }
        
        .hamburger-icon {
            width: 24px;
            height: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .hamburger-line {
            width: 100%;
            height: 3px;
            background: var(--accent-blue);
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .hamburger.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translateY(8px);
        }
        
        .hamburger.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translateY(-8px);
        }
        
        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }
        
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .timer-display {
                font-size: 72px;
            }
            
            .focus-timer-display {
                font-size: 96px;
            }
        }
        
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                height: 100vh;
                border-right: 1px solid var(--border-color);
                border-bottom: none;
                padding: 24px 16px;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
            }
            
            .sidebar.mobile-hidden {
                transform: translateX(-100%);
            }
            
            .main-content {
                padding: 16px;
                padding-top: 70px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 56px;
            }
            
            .focus-timer-display {
                font-size: 72px;
            }
            
            .timer-controls {
                flex-direction: column;
            }
            
            .timer-controls .btn {
                width: 100%;
            }
            
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .fiches-header {
                flex-direction: column;
            }
            
            .search-bar {
                max-width: 100%;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .timer-display {
                font-size: 48px;
            }
            
            .focus-timer-display {
                font-size: 56px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .matiere-grid {
                grid-template-columns: 1fr;
            }
            
            .image-gallery {
                grid-template-columns: 1fr;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
        }
        /* SKELETON LOADERS */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(48, 54, 61, 0.3) 25%, 
                rgba(88, 166, 255, 0.1) 50%, 
                rgba(48, 54, 61, 0.3) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }
        
        .skeleton-card {
            height: 120px;
            margin-bottom: 16px;
        }
        
        /* CONFETTI */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent-blue);
            animation: confetti 3s ease-out forwards;
            z-index: 10000;
        }
        
        .confetti:nth-child(2n) { background: var(--accent-green); }
        .confetti:nth-child(3n) { background: var(--accent-yellow); }
        .confetti:nth-child(4n) { background: var(--accent-red); }
        
        /* LEVEL UP ANIMATION */
        .level-up-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        }
        
        .level-up-content {
            text-align: center;
            animation: scaleIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .level-up-content h1 {
            font-size: 72px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: pulse 1s ease infinite;
        }
        
        /* CIRCULAR PROGRESS */
        .circular-progress {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        
        .circular-progress svg {
            transform: rotate(-90deg);
        }
        
        .circular-progress circle {
            fill: none;
            stroke-width: 10;
        }
        
        .circular-progress .bg {
            stroke: rgba(48, 54, 61, 0.5);
        }
        
        .circular-progress .progress {
            stroke: url(#gradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .circular-progress .text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 800;
            color: var(--accent-blue);
        }
        
        /* ACHIEVEMENT POPUP */
        .achievement-popup {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--accent-green);
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 12px 40px rgba(35, 134, 54, 0.5);
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            max-width: 350px;
        }
        
        .achievement-popup h3 {
            color: var(--accent-green);
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .achievement-popup p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
            animation: float 3s ease-in-out infinite;
        }
        
        .empty-state h3 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        /* TOOLTIP */
        .tooltip {
            position: absolute;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10000;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* ACTIVITY HEATMAP */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 20px 0;
        }
        
        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .heatmap-day:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        
        .heatmap-day.level-1 { background: rgba(88, 166, 255, 0.2); }
        .heatmap-day.level-2 { background: rgba(88, 166, 255, 0.4); }
        .heatmap-day.level-3 { background: rgba(88, 166, 255, 0.6); }
        .heatmap-day.level-4 { background: rgba(88, 166, 255, 0.8); }
        .heatmap-day.level-5 { background: rgba(88, 166, 255, 1); box-shadow: 0 0 10px var(--accent-blue); }
        
        /* XP BAR UNDER NAVBAR */
        .global-xp-bar {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 3px;
            background: rgba(48, 54, 61, 0.5);
            z-index: 999;
            transition: left 0.3s ease;
        }
        
        .global-xp-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--accent-blue);
        }
        
        /* BADGE 3D EFFECT */
        .badge-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s;
        }
        
        .badge-3d:hover {
            transform: rotateY(15deg) rotateX(5deg);
        }
        
        .badge-3d::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: -5px;
            bottom: -5px;
            background: inherit;
            filter: blur(10px);
            opacity: 0.3;
            z-index: -1;
            transform: translateZ(-10px);
        }
        
        /* FLOATING PARTICLES */
        .particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: rgba(88, 166, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }
        
        /* INPUT FOCUS GLOW */
        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.15),
                        0 0 20px rgba(88, 166, 255, 0.3);
            animation: glow 2s ease infinite;
        }
        
        /* CARD FLIP 3D */
        .flip-card {
            perspective: 1000px;
            cursor: pointer;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
        }
        
        .flip-card-back {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <!-- Global XP Bar -->
    <div class="global-xp-bar">
        <div class="global-xp-progress" id="globalXPProgress" style="width: 0%"></div>
    </div>
    
    <!-- Hamburger Menu (mobile) -->
    <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
        <div class="hamburger-icon">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </div>
    </div>
    
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="logo">📚 Study Game Ultimate</div>
            
            <div class="user-profile">
                <div class="user-title" id="userTitle">Novice</div>
                <div class="user-level">Niveau <span id="sidebarLevel">1</span> • <span id="sidebarXP">0</span> XP</div>
            </div>
            
            <div class="combo-display" id="comboDisplay">
                <div class="combo-days" id="comboDays">0</div>
                <div class="combo-label">🔥 JOURS DE SUITE</div>
            </div>
            
            <nav>
                <div class="nav-item active" onclick="showPage('dashboard')">🏠 Dashboard</div>
                <div class="nav-item" onclick="showPage('timer')">⏱️ Entraînement</div>
                <div class="nav-item" onclick="showPage('methods')">🧠 Méthodes</div>
                <div class="nav-item" onclick="showPage('fiches')">📝 Fiches</div>
                <div class="nav-item" onclick="showPage('objectives')">🎯 Objectifs</div>
                <div class="nav-item" onclick="showPage('quests')">⚔️ Quêtes</div>
                <div class="nav-item" onclick="showPage('calendar')">📅 Calendrier</div>
                <div class="nav-item" onclick="showPage('achievements')">🏆 Succès</div>
                <div class="nav-item" onclick="showPage('stats')">📊 Statistiques</div>
                <div class="nav-item" onclick="showPage('settings')">⚙️ Paramètres</div>
            </nav>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- DASHBOARD -->
            <div id="dashboard-page" class="page active">
                <div class="header">
                    <h1>Tableau de Bord</h1>
                    <p>Suivi de ta progression</p>
                </div>
                
                <div class="quote-card" id="quoteCard">
                    "Le succès n'est pas final, l'échec n'est pas fatal : c'est le courage de continuer qui compte."
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Niveau Global</div>
                        <div class="stat-value" id="globalLevel">1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">XP Total</div>
                        <div class="stat-value" id="totalXP">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sessions Complétées</div>
                        <div class="stat-value" id="totalSessions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Temps Total</div>
                        <div class="stat-value" id="totalTime">0h</div>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 16px; font-size: 24px;">Progression par Matière</h2>
                <div id="matiereStats"></div>
                
                <h2 style="margin-top: 32px; margin-bottom: 16px; font-size: 24px;">Sessions Récentes</h2>
                <div class="session-list" id="sessionList"></div>
            </div>
            
            <!-- TIMER -->
            <div id="timer-page" class="page">
                <div class="header">
                    <h1>⏱️ Entraînement</h1>
                    <p>Lance une session d'étude</p>
                </div>
                
                <div class="timer-container">
                    <div class="timer-display" id="timerDisplay">25:00</div>
                    
                    <div class="preset-buttons">
                        <button class="preset-btn active" onclick="setTimer(25, 'Pomodoro')">🍅 Pomodoro<br>25 min</button>
                        <button class="preset-btn" onclick="setTimer(15, 'Flash')">⚡ Flash<br>15 min</button>
                        <button class="preset-btn" onclick="setTimer(45, 'Intensif')">🔥 Intensif<br>45 min</button>
                        <button class="preset-btn" onclick="setTimer(90, 'Deep Work')">🧠 Deep Work<br>90 min</button>
                        <button class="preset-btn" onclick="setTimer(5, 'Pause')">☕ Pause<br>5 min</button>
                    </div>
                    
                    <div class="timer-controls">
                        <button class="btn btn-primary" onclick="startTimer()">▶️ Démarrer</button>
                        <button class="btn btn-secondary" onclick="pauseTimer()">⏸️ Pause</button>
                        <button class="btn btn-secondary" onclick="resetTimer()">🔄 Reset</button>
                        <button class="btn btn-info" onclick="toggleFocusMode()">🎯 Mode Focus</button>
                        <button class="btn btn-danger" onclick="finishSession()">✓ Terminer</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Matière</label>
                        <select id="timerMatiere" class="form-control">
                            <option>Mathématiques</option>
                            <option>Physique</option>
                            <option>Biologie</option>
                            <option>Agronomie</option>
                            <option>Aménagement Paysager</option>
                            <option>Agro-équipement</option>
                            <option>Espagnol</option>
                            <option>Philosophie</option>
                            <option>Histoire-Géo</option>
                            <option>Économie</option>
                        </select>
                    </div>
                </div>
                
                <div class="timer-container">
                    <h3 style="margin-bottom: 16px;">Ajouter XP Manuellement</h3>
                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <input type="text" id="manualNote" class="form-control" placeholder="Ex: Devoir maison, exposé...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">XP à ajouter</label>
                        <input type="number" id="manualXP" class="form-control" value="50" min="1">
                    </div>
                    <button class="btn btn-primary" onclick="addManualXP()">➕ Ajouter XP</button>
                </div>
            </div>
            
            <!-- METHODS -->
            <div id="methods-page" class="page">
                <div class="header">
                    <h1>🧠 Méthodes de Révision</h1>
                    <p>Techniques efficaces pour optimiser tes révisions</p>
                </div>
                
                <div class="flash-info">
                    <h2>⚡ Révision Flash - 15 minutes</h2>
                    <p><strong>Parfait pour réviser rapidement entre deux cours !</strong></p>
                    <p>En 15 minutes, tu peux :</p>
                    <ul>
                        <li><strong>0-3 min :</strong> Révise 10-15 flashcards d'une matière</li>
                        <li><strong>3-8 min :</strong> Lis et surligne les points clés d'un cours</li>
                        <li><strong>8-12 min :</strong> Fais un exercice rapide ou résous un problème</li>
                        <li><strong>12-15 min :</strong> Résume ce que tu viens d'apprendre en 3-5 phrases</li>
                    </ul>
                    <p><strong>Astuce :</strong> Les sessions courtes et régulières sont plus efficaces qu'une longue session occasionnelle !</p>
                </div>
                
                <div class="method-card">
                    <h3>🍅 Technique Pomodoro</h3>
                    <p><strong>La méthode de productivité la plus populaire</strong></p>
                    <p>Alternance entre périodes de travail intense et pauses courtes :</p>
                    <ul>
                        <li>Travaille pendant 25 minutes sans interruption</li>
                        <li>Prends une pause de 5 minutes</li>
                        <li>Après 4 cycles, prends une pause de 15-30 minutes</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Maintient ta concentration et prévient la fatigue mentale</p>
                </div>
                
                <div class="method-card">
                    <h3>🔄 Répétition Espacée</h3>
                    <p><strong>La science de la mémorisation à long terme</strong></p>
                    <p>Révise le même contenu à intervalles croissants :</p>
                    <ul>
                        <li>Jour 1 : Apprends le contenu</li>
                        <li>Jour 2 : Première révision</li>
                        <li>Jour 5 : Deuxième révision</li>
                        <li>Jour 14 : Troisième révision</li>
                        <li>Jour 30 : Quatrième révision</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Exploite la courbe d'oubli d'Ebbinghaus pour optimiser la mémorisation</p>
                </div>
                
                <div class="method-card">
                    <h3>🎓 Méthode Feynman</h3>
                    <p><strong>Apprends en expliquant simplement</strong></p>
                    <p>4 étapes pour maîtriser n'importe quel concept :</p>
                    <ul>
                        <li><strong>Étape 1 :</strong> Choisis un concept et écris tout ce que tu sais dessus</li>
                        <li><strong>Étape 2 :</strong> Explique-le comme si tu enseignais à un enfant de 12 ans</li>
                        <li><strong>Étape 3 :</strong> Identifie les lacunes dans ton explication</li>
                        <li><strong>Étape 4 :</strong> Simplifie et utilise des analogies</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Si tu peux l'expliquer simplement, tu le comprends vraiment</p>
                </div>
                
                <div class="method-card">
                    <h3>🗺️ Mind Mapping</h3>
                    <p><strong>Visualise les connexions entre les concepts</strong></p>
                    <p>Crée une carte mentale en :</p>
                    <ul>
                        <li>Plaçant le concept principal au centre</li>
                        <li>Ajoutant des branches pour les sous-thèmes</li>
                        <li>Utilisant des couleurs et des dessins</li>
                        <li>Reliant les idées similaires entre elles</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Stimule la créativité et aide à voir la vue d'ensemble</p>
                </div>
                
                <div class="method-card">
                    <h3>📝 Rappel Actif (Active Recall)</h3>
                    <p><strong>Teste-toi au lieu de relire passivement</strong></p>
                    <p>Techniques de rappel actif :</p>
                    <ul>
                        <li>Ferme ton cours et essaie de tout réécrire de mémoire</li>
                        <li>Crée des flashcards avec des questions</li>
                        <li>Explique à voix haute sans notes</li>
                        <li>Fais des quiz et exercices avant de revoir le cours</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Force ton cerveau à récupérer l'information, renforçant les connexions neuronales</p>
                </div>
                
                <div class="method-card">
                    <h3>🎯 Méthode Cornell</h3>
                    <p><strong>Système de prise de notes structuré</strong></p>
                    <p>Divise ta page en 3 sections :</p>
                    <ul>
                        <li><strong>Colonne de droite (70%) :</strong> Notes pendant le cours</li>
                        <li><strong>Colonne de gauche (30%) :</strong> Mots-clés et questions</li>
                        <li><strong>Bas de page :</strong> Résumé en 2-3 phrases</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Organise l'information et facilite la révision</p>
                </div>
                
                <div class="method-card">
                    <h3>🔢 Méthode SQ3R</h3>
                    <p><strong>Technique de lecture active pour mieux retenir</strong></p>
                    <p>5 étapes pour lire efficacement :</p>
                    <ul>
                        <li><strong>Survey (Survol) :</strong> Parcours rapidement le chapitre</li>
                        <li><strong>Question :</strong> Pose-toi des questions sur le contenu</li>
                        <li><strong>Read (Lis) :</strong> Lis attentivement en cherchant les réponses</li>
                        <li><strong>Recite (Récite) :</strong> Résume à voix haute sans regarder</li>
                        <li><strong>Review (Révise) :</strong> Revois régulièrement</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Transforme la lecture passive en apprentissage actif</p>
                </div>
                
                <div class="method-card">
                    <h3>🎨 Méthode Leitner</h3>
                    <p><strong>Système de flashcards intelligent</strong></p>
                    <p>Organise tes flashcards en 5 boîtes :</p>
                    <ul>
                        <li><strong>Boîte 1 :</strong> Révise tous les jours</li>
                        <li><strong>Boîte 2 :</strong> Révise tous les 3 jours</li>
                        <li><strong>Boîte 3 :</strong> Révise toutes les semaines</li>
                        <li><strong>Boîte 4 :</strong> Révise tous les 15 jours</li>
                        <li><strong>Boîte 5 :</strong> Révise tous les mois</li>
                    </ul>
                    <p><strong>Astuce :</strong> Si tu te trompes, la carte redescend en boîte 1</p>
                    <p><strong>Pourquoi ça marche :</strong> Concentre tes efforts sur ce que tu maîtrises le moins</p>
                </div>
                
                <div class="method-card">
                    <h3>🧠 Méthode Deep Work (Travail Profond)</h3>
                    <p><strong>Sessions intensives de 90 minutes</strong></p>
                    <p>Maximise ta concentration pour un apprentissage en profondeur :</p>
                    <ul>
                        <li>Élimine TOUTES les distractions (téléphone en mode avion, notifications off)</li>
                        <li>Travaille sur une seule tâche complexe pendant 90 minutes</li>
                        <li>Prends une pause de 20-30 minutes après</li>
                        <li>Maximum 2-3 sessions de Deep Work par jour</li>
                    </ul>
                    <p><strong>Pourquoi ça marche :</strong> Les tâches complexes nécessitent une concentration sans interruption. 90 minutes est la durée optimale avant fatigue cognitive.</p>
                </div>
            </div>
            
            <!-- FICHES -->
            <div id="fiches-page" class="page">
                <div class="header">
                    <h1>📝 Fiches de Révision</h1>
                    <p>Organise tes fiches par matière</p>
                </div>
                
                <div class="search-box">
                    <input type="text" id="ficheSearch" class="form-control" placeholder="🔍 Rechercher dans les fiches..." oninput="searchFiches()">
                </div>
                
                <div id="ficheMainView">
                    <h2 style="margin-bottom: 16px;">Sélectionne une matière</h2>
                    <div class="matiere-selector" id="ficheMatiereSelector"></div>
                </div>
                
                <div id="ficheGroupeView" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="backToFicheMatieres()">← Retour aux matières</button>
                    
                    <div class="fiches-header">
                        <h2 id="currentFicheMatiereName"></h2>
                        <button class="btn btn-primary" onclick="showAddFicheGroupeModal()">+ Nouveau Chapitre</button>
                    </div>
                    
                    <div class="groupes-list" id="ficheGroupesList"></div>
                </div>
                
                <div id="ficheContentView" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="backToFicheGroupes()">← Retour aux chapitres</button>
                    
                    <div class="fiches-header">
                        <h2 id="currentFicheGroupeName"></h2>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <label class="file-input-label" for="ficheImageUpload">📷 Ajouter Image</label>
                            <input type="file" id="ficheImageUpload" accept="image/*" multiple onchange="uploadFicheImages()">
                            <button class="btn btn-info" onclick="showAddTextModal()">📝 Ajouter Texte</button>
                            <button class="btn btn-secondary" onclick="toggleFicheFavorite()">⭐ Favori</button>
                            <button class="btn btn-secondary" onclick="showAddTagModal()">🏷️ Tag</button>
                            <button class="btn btn-danger" onclick="deleteFicheGroupe()">🗑️ Supprimer</button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="switchFicheTab('images')">📷 Images</button>
                        <button class="tab" onclick="switchFicheTab('texts')">📝 Textes</button>
                    </div>
                    
                    <div id="ficheImagesTab">
                        <div class="images-grid" id="ficheImagesList"></div>
                    </div>
                    
                    <div id="ficheTextsTab" style="display: none;">
                        <div id="ficheTextsList"></div>
                    </div>
                </div>
                
                <div id="ficheSearchResults" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="clearFicheSearch()">← Retour</button>
                    <h2 style="margin-bottom: 16px;">Résultats de recherche</h2>
                    <div class="groupes-list" id="ficheSearchResultsList"></div>
                </div>
            </div>
            
            <!-- COURS -->
            <div id="cours-page" class="page">
                <div class="header">
                    <h1>📚 Mes Cours</h1>
                    <p>Organise tes cours et notes</p>
                </div>
                
                <div id="coursMainView">
                    <h2 style="margin-bottom: 16px;">Sélectionne une matière</h2>
                    <div class="matiere-selector" id="coursMatiereSelector"></div>
                </div>
                
                <div id="coursGroupeView" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="backToCoursMatieres()">← Retour aux matières</button>
                    
                    <div class="fiches-header">
                        <h2 id="currentCoursMatiereName"></h2>
                        <button class="btn btn-primary" onclick="showAddCoursGroupeModal()">+ Nouveau Cours</button>
                    </div>
                    
                    <div class="groupes-list" id="coursGroupesList"></div>
                </div>
                
                <div id="coursContentView" style="display: none;">
                    <button class="btn btn-secondary back-btn" onclick="backToCoursGroupes()">← Retour aux cours</button>
                    
                    <div class="fiches-header">
                        <h2 id="currentCoursGroupeName"></h2>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <label class="file-input-label" for="coursFileUpload">📎 Ajouter Fichier</label>
                            <input type="file" id="coursFileUpload" accept="image/*,.pdf,.doc,.docx" multiple onchange="uploadCoursFiles()">
                            <button class="btn btn-info" onclick="showAddCoursNoteModal()">📝 Ajouter Note</button>
                            <button class="btn btn-danger" onclick="deleteCoursGroupe()">🗑️ Supprimer</button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="switchCoursTab('files')">📎 Fichiers</button>
                        <button class="tab" onclick="switchCoursTab('notes')">📝 Notes</button>
                    </div>
                    
                    <div id="coursFilesTab">
                        <div class="images-grid" id="coursFilesList"></div>
                    </div>
                    
                    <div id="coursNotesTab" style="display: none;">
                        <div id="coursNotesList"></div>
                    </div>
                </div>
            </div>
            
            <!-- OBJECTIVES -->
            <div id="objectives-page" class="page">
                <div class="header">
                    <h1>🎯 Objectifs</h1>
                    <p>Définis et atteins tes objectifs</p>
                </div>
                
                <button class="btn btn-primary" style="margin-bottom: 24px;" onclick="showAddObjectiveModal()">+ Nouvel Objectif</button>
                
                <div id="objectivesList"></div>
            </div>
            
            <!-- QUESTS -->
            <div id="quests-page" class="page">
                <div class="header">
                    <h1>⚔️ Quêtes Quotidiennes</h1>
                    <p>Complète tes quêtes pour gagner des bonus XP !</p>
                </div>
                
                <div id="questsList"></div>
            </div>
            
            <!-- CALENDAR -->
            <div id="calendar-page" class="page">
                <div class="header">
                    <h1>📅 Calendrier</h1>
                    <p>Visualise ton historique et planifie</p>
                </div>
                
                <button class="btn btn-primary" style="margin-bottom: 24px;" onclick="showAddImportantDateModal()">+ Ajouter Date Importante</button>
                
                <div class="calendar-header">
                    <h2 id="currentMonth"></h2>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="changeMonth(-1)">← Précédent</button>
                        <button class="btn btn-secondary" onclick="changeMonth(0)">Aujourd'hui</button>
                        <button class="btn btn-secondary" onclick="changeMonth(1)">Suivant →</button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div id="dayDetails" style="display: none; margin-top: 24px;">
                    <h3 id="dayDetailsTitle"></h3>
                    <div id="dayDetailsContent"></div>
                </div>
            </div>
            
            <!-- ACHIEVEMENTS -->
            <div id="achievements-page" class="page">
                <div class="header">
                    <h1>🏆 Succès & Badges</h1>
                    <p id="achievementCount">0 succès débloqués</p>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchAchTab('achievements')">🏆 Succès</button>
                    <button class="tab" onclick="switchAchTab('badges')">🎖️ Badges</button>
                </div>
                
                <div id="achievementsTab">
                    <div class="achievements-grid" id="achievementsList"></div>
                </div>
                
                <div id="badgesTab" style="display: none;">
                    <div class="achievements-grid" id="badgesList"></div>
                </div>
            </div>
            
            <!-- STATS -->
            <div id="stats-page" class="page">
                <div class="header">
                    <h1>📊 Statistiques Détaillées</h1>
                    <p>Analyse ta progression</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Sessions cette semaine</div>
                        <div class="stat-value" id="statsWeekSessions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Temps cette semaine</div>
                        <div class="stat-value" id="statsWeekTime">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Temps ce mois</div>
                        <div class="stat-value" id="statsMonthTime">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Moyenne par session</div>
                        <div class="stat-value" id="statsAvgSession">0min</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Meilleure période</div>
                        <div class="stat-value" id="statsBestPeriod">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Combo record</div>
                        <div class="stat-value" id="statsMaxCombo">0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 16px;">Progression XP (30 derniers jours)</h3>
                    <canvas id="xpChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 16px;">Temps par Matière</h3>
                    <canvas id="matiereChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 16px;">Activité Hebdomadaire</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
            
            <!-- SETTINGS -->
            <div id="settings-page" class="page">
                <div class="header">
                    <h1>⚙️ Paramètres</h1>
                    <p>Personnalise ton expérience</p>
                </div>
                
                <div class="settings-section">
                    <h3>🎨 Apparence</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Thème</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Change l'apparence de l'interface</div>
                        </div>
                        <div class="theme-selector">
                            <button class="theme-btn active" data-theme="dark" onclick="changeTheme('dark')">🌙 Sombre</button>
                            <button class="theme-btn" data-theme="light" onclick="changeTheme('light')">☀️ Clair</button>
                            <button class="theme-btn" data-theme="nord" onclick="changeTheme('nord')">❄️ Nord</button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔧 Fonctionnalités</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Sons</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Active/désactive les sons de notification</div>
                        </div>
                        <div class="toggle" id="soundsToggle" onclick="toggleSounds()">
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>💾 Données</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Backup</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Sauvegarde toutes tes données</div>
                        </div>
                        <button class="btn btn-primary" onclick="backupData()">💾 Sauvegarder</button>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Export</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Exporte tes données en JSON</div>
                        </div>
                        <button class="btn btn-secondary" onclick="exportData()">📤 Exporter</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>ℹ️ Informations</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 600;">Version</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Study Game Ultimate v3.0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <img id="modalImage" src="" alt="Image">
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn btn-danger" onclick="deleteCurrentImage()">🗑️ Supprimer</button>
                <button class="btn btn-secondary" onclick="closeImageModal()">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="addFicheGroupeModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 16px;">Nouveau Chapitre</h2>
            <div class="form-group">
                <label class="form-label">Nom du chapitre</label>
                <input type="text" id="newFicheGroupeName" class="form-control" placeholder="Ex: Chapitre 1 - Les équations">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="createFicheGroupe()">Créer</button>
                <button class="btn btn-secondary" onclick="closeAddFicheGroupeModal()">Annuler</button>
            </div>
        </div>
    </div>
    
    <div id="addTextModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 16px;">Ajouter Fiche Texte</h2>
            <div class="form-group">
                <label class="form-label">Titre</label>
                <input type="text" id="newTextTitle" class="form-control" placeholder="Titre de la fiche">
            </div>
            <div class="form-group">
                <label class="form-label">Contenu</label>
                <textarea id="newTextContent" class="form-control" placeholder="# Titre Principal&#10;## Sous-titre&#10;&#10;**Texte en gras** et *italique*&#10;&#10;- Point 1&#10;- Point 2&#10;&#10;1. Numéro 1&#10;2. Numéro 2&#10;&#10;`code`&#10;&#10;> Citation" style="min-height: 250px;"></textarea>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="addTextFiche()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeAddTextModal()">Annuler</button>
            </div>
        </div>
    </div>
    
    <div id="addTagModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 16px;">Ajouter un Tag</h2>
            <div class="form-group">
                <label class="form-label">Tag</label>
                <input type="text" id="newTag" class="form-control" placeholder="Ex: Important, Formules...">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="addTag()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeAddTagModal()">Annuler</button>
            </div>
        </div>
    </div>
    

    
    <div id="addObjectiveModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 16px;">Nouvel Objectif</h2>
            <div class="form-group">
                <label class="form-label">Titre</label>
                <input type="text" id="objTitle" class="form-control" placeholder="Ex: Atteindre niveau 20">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="objDescription" class="form-control" placeholder="Description de l'objectif..." style="min-height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select id="objType" class="form-control">
                    <option value="xp">XP</option>
                    <option value="time">Temps (minutes)</option>
                    <option value="sessions">Sessions</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Valeur Cible</label>
                <input type="number" id="objTarget" class="form-control" placeholder="Ex: 5000" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Matière (optionnel)</label>
                <select id="objMatiere" class="form-control">
                    <option value="">Toutes les matières</option>
                    <option>Mathématiques</option>
                    <option>Physique</option>
                    <option>Biologie</option>
                    <option>Agronomie</option>
                    <option>Aménagement Paysager</option>
                    <option>Agro-équipement</option>
                    <option>Espagnol</option>
                    <option>Philosophie</option>
                    <option>Histoire-Géo</option>
                    <option>Économie</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="addObjective()">Créer</button>
                <button class="btn btn-secondary" onclick="closeAddObjectiveModal()">Annuler</button>
            </div>
        </div>
    </div>
    
    <div id="addImportantDateModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 16px;">Ajouter Date Importante</h2>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="importantDate" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Titre</label>
                <input type="text" id="importantTitle" class="form-control" placeholder="Ex: Examen de mathématiques">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="importantDescription" class="form-control" placeholder="Description..." style="min-height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Matière (optionnel)</label>
                <select id="importantMatiere" class="form-control">
                    <option value="">Aucune matière</option>
                    <option>Mathématiques</option>
                    <option>Physique</option>
                    <option>Biologie</option>
                    <option>Agronomie</option>
                    <option>Aménagement Paysager</option>
                    <option>Agro-équipement</option>
                    <option>Espagnol</option>
                    <option>Philosophie</option>
                    <option>Histoire-Géo</option>
                    <option>Économie</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="addImportantDate()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeAddImportantDateModal()">Annuler</button>
            </div>
        </div>
    </div>
    
    <script>

// ==================== CONFIGURATION ====================
const GOOGLE_SCRIPT_URL = 'VOTRE_URL_GOOGLE_APPS_SCRIPT_ICI';

// ==================== STUDY GAME API (converted from Python) ====================
class StudyGameAPI {
    constructor() {
        this.data = null;
    }
    
    async loadData() {
        try {
            if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== 'VOTRE_URL_GOOGLE_APPS_SCRIPT_ICI') {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=get');
                if (response.ok) {
                    this.data = await response.json();
                    localStorage.setItem('studyData', JSON.stringify(this.data));
                    return;
                }
            }
        } catch (error) {
            console.log('Google Apps Script non disponible');
        }
        
        const stored = localStorage.getItem('studyData');
        if (stored) {
            this.data = JSON.parse(stored);
        } else {
            this.data = this.createDefaultData();
            await this.saveData();
        }
    }
    
    createDefaultData() {
        return {
            total_xp: 0,
            level: 1,
            title: "Novice",
            combo_days: 0,
            last_session_date: null,
            theme: "dark",
            sounds_enabled: true,
            focus_mode: false,
            matieres: {
                "Mathématiques": { xp: 0, level: 1, temps_total: 0 },
                "Physique": { xp: 0, level: 1, temps_total: 0 },
                "Biologie": { xp: 0, level: 1, temps_total: 0 },
                "Agronomie": { xp: 0, level: 1, temps_total: 0 },
                "Aménagement Paysager": { xp: 0, level: 1, temps_total: 0 },
                "Agro-équipement": { xp: 0, level: 1, temps_total: 0 },
                "Espagnol": { xp: 0, level: 1, temps_total: 0 },
                "Philosophie": { xp: 0, level: 1, temps_total: 0 },
                "Histoire-Géo": { xp: 0, level: 1, temps_total: 0 },
                "Économie": { xp: 0, level: 1, temps_total: 0 }
            },
            sessions: [],
            calendar: {},
            achievements: [],
            badges: [],
            fiches: {},
            objectives: [],
            daily_quests: [],
            start_times: {},
            important_dates: {},
            favorites: [],
            tags: {}
        };
    }
    
    async saveData() {
        localStorage.setItem('studyData', JSON.stringify(this.data));
        
        if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== 'VOTRE_URL_GOOGLE_APPS_SCRIPT_ICI') {
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save', data: this.data })
                });
            } catch (error) {
                console.log('Erreur sync:', error);
            }
        }
    }
    
    async get_data() {
        this.check_daily_quests();
        this.update_title();
        return this.data;
    }
    
    update_title() {
        const level = this.data.level;
        let title = "Novice";
        if (level >= 100) title = "Légende Vivante";
        else if (level >= 75) title = "Sage";
        else if (level >= 50) title = "Grand Maître";
        else if (level >= 35) title = "Maître";
        else if (level >= 20) title = "Expert";
        else if (level >= 10) title = "Adepte";
        else if (level >= 5) title = "Apprenti";
        this.data.title = title;
    }
    
    check_daily_quests() {
        const today = new Date().toISOString().split('T')[0];
        if (!this.data.daily_quests.length || this.data.daily_quests[0].date !== today) {
            this.data.daily_quests = [
                { id: "session_count", title: "🎯 Complète 3 sessions", description: "Fais 3 sessions d'étude aujourd'hui", target: 3, current: 0, xp_reward: 100, completed: false, date: today },
                { id: "study_time", title: "⏱️ Étudie 60 minutes", description: "Accumule 60 minutes d'étude", target: 60, current: 0, xp_reward: 150, completed: false, date: today },
                { id: "two_subjects", title: "📚 Deux matières", description: "Étudie au moins 2 matières différentes", target: 2, current: 0, xp_reward: 80, completed: false, date: today }
            ];
        }
    }
    
    async start_session(matiere, type_session) {
        const now = new Date();
        const session_key = `${matiere}_${type_session}_${now.getTime()}`;
        this.data.start_times[session_key] = now.toISOString();
        await this.saveData();
        return { success: true, session_key: session_key };
    }
    
    async add_session(matiere, type_session, duree_minutes, xp_gagne, session_key = null) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        
        // Combo
        this.update_combo(dateStr);
        const combo_bonus = Math.min(this.data.combo_days * 0.1, 1.0);
        const xp_with_bonus = Math.floor(xp_gagne * (1 + combo_bonus));
        
        let startTime, endTime;
        if (session_key && this.data.start_times[session_key]) {
            startTime = new Date(this.data.start_times[session_key]);
            endTime = new Date(startTime.getTime() + duree_minutes * 60000);
            delete this.data.start_times[session_key];
        } else {
            endTime = now;
            startTime = new Date(endTime.getTime() - duree_minutes * 60000);
        }
        
        const session = {
            date: now.toISOString(),
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            matiere: matiere,
            type: type_session,
            duree: duree_minutes,
            xp: xp_with_bonus,
            combo_bonus: combo_bonus
        };
        
        this.data.sessions.push(session);
        
        if (!this.data.calendar[dateStr]) this.data.calendar[dateStr] = [];
        this.data.calendar[dateStr].push({
            matiere: matiere,
            type: type_session,
            duree: duree_minutes,
            start_time: startTime.toTimeString().substring(0, 5),
            end_time: endTime.toTimeString().substring(0, 5)
        });
        
        this.data.total_xp += xp_with_bonus;
        const oldLevel = this.data.level;
        this.data.level = Math.floor(this.data.total_xp / 500) + 1;
        
        if (this.data.matieres[matiere]) {
            this.data.matieres[matiere].xp += xp_with_bonus;
            this.data.matieres[matiere].temps_total += duree_minutes;
            this.data.matieres[matiere].level = Math.floor(this.data.matieres[matiere].xp / 100) + 1;
        }
        
        this.data.last_session_date = dateStr;
        
        this.update_quest_progress(type_session, duree_minutes);
        this.check_achievements(matiere, duree_minutes, startTime.getHours());
        
        await this.saveData();
        
        return {
            success: true,
            new_level: this.data.level,
            level_up: this.data.level > oldLevel,
            xp_gained: xp_with_bonus
        };
    }
    
    update_combo(dateStr) {
        if (!this.data.last_session_date) {
            this.data.combo_days = 1;
        } else {
            const lastDate = new Date(this.data.last_session_date);
            const currentDate = new Date(dateStr);
            const diffDays = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Même jour
            } else if (diffDays === 1) {
                this.data.combo_days++;
            } else {
                this.data.combo_days = 1;
            }
        }
    }
    
    update_quest_progress(type, minutes) {
        const today = new Date().toISOString().split('T')[0];
        
        this.data.daily_quests.forEach(quest => {
            if (quest.date !== today || quest.completed) return;
            
            if (quest.id === 'session_count') {
                quest.current++;
            } else if (quest.id === 'study_time') {
                quest.current += minutes;
            }
            
            if (quest.current >= quest.target && !quest.completed) {
                quest.completed = true;
                this.data.total_xp += quest.xp_reward;
            }
        });
    }
    
    check_achievements(matiere, duree, heure) {
        // Simplified achievements
        const achievements = [];
        
        if (this.data.sessions.length === 1) {
            achievements.push({ title: "🎯 Première Session", description: "Tu as commencé ton parcours!", date: new Date().toISOString() });
        }
        
        if (this.data.total_xp >= 1000 && !this.data.achievements.some(a => a.title.includes("1000 XP"))) {
            achievements.push({ title: "⭐ 1000 XP", description: "Tu as atteint 1000 XP!", date: new Date().toISOString() });
        }
        
        achievements.forEach(ach => {
            if (!this.data.achievements.some(a => a.title === ach.title)) {
                this.data.achievements.push(ach);
            }
        });
        
        return achievements;
    }
    
    async get_statistics() {
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        const weekSessions = this.data.sessions.filter(s => new Date(s.date) >= weekAgo);
        const monthSessions = this.data.sessions.filter(s => new Date(s.date) >= monthAgo);
        
        const timeWeek = weekSessions.reduce((sum, s) => sum + s.duree, 0);
        const timeMonth = monthSessions.reduce((sum, s) => sum + s.duree, 0);
        const avgSession = this.data.sessions.length > 0 
            ? Math.floor(this.data.sessions.reduce((sum, s) => sum + s.duree, 0) / this.data.sessions.length)
            : 0;
        
        return {
            sessions_week: weekSessions.length,
            time_week: timeWeek,
            time_month: timeMonth,
            avg_session: avgSession,
            best_period: "Matin",
            max_combo: this.data.combo_days
        };
    }
    
    async get_calendar_month(year, month) {
        const calendar = {};
        Object.keys(this.data.calendar).forEach(dateStr => {
            const date = new Date(dateStr);
            if (date.getFullYear() === year && date.getMonth() + 1 === month) {
                calendar[dateStr] = this.data.calendar[dateStr];
            }
        });
        return calendar;
    }
    
    async create_fiche_groupe(matiere, nom) {
        if (!this.data.fiches[matiere]) {
            this.data.fiches[matiere] = {};
        }
        
        if (this.data.fiches[matiere][nom]) {
            return { success: false, error: "Ce chapitre existe déjà" };
        }
        
        this.data.fiches[matiere][nom] = {
            images: [],
            texts: [],
            date_creation: new Date().toISOString()
        };
        
        await this.saveData();
        return { success: true };
    }
    
    async add_image_to_groupe(matiere, groupe, base64_data, nom) {
        if (!this.data.fiches[matiere] || !this.data.fiches[matiere][groupe]) {
            return { success: false, error: "Groupe introuvable" };
        }
        
        this.data.fiches[matiere][groupe].images.push({
            data: base64_data,
            nom: nom,
            date_ajout: new Date().toISOString()
        });
        
        await this.saveData();
        return { success: true };
    }
    
    async add_text_to_groupe(matiere, groupe, title, content) {
        if (!this.data.fiches[matiere] || !this.data.fiches[matiere][groupe]) {
            return { success: false, error: "Groupe introuvable" };
        }
        
        this.data.fiches[matiere][groupe].texts.push({
            title: title,
            content: content,
            date_ajout: new Date().toISOString()
        });
        
        await this.saveData();
        return { success: true };
    }
    
    async toggle_favorite(matiere, groupe) {
        const key = `${matiere}::${groupe}`;
        const index = this.data.favorites.indexOf(key);
        
        if (index === -1) {
            this.data.favorites.push(key);
            await this.saveData();
            return { success: true, is_favorite: true };
        } else {
            this.data.favorites.splice(index, 1);
            await this.saveData();
            return { success: true, is_favorite: false };
        }
    }
    
    async add_tag(matiere, groupe, tag) {
        const key = `${matiere}::${groupe}`;
        if (!this.data.tags[key]) {
            this.data.tags[key] = [];
        }
        
        if (!this.data.tags[key].includes(tag)) {
            this.data.tags[key].push(tag);
            await this.saveData();
        }
        
        return { success: true };
    }
    
    async delete_fiche_groupe(matiere, groupe) {
        if (this.data.fiches[matiere] && this.data.fiches[matiere][groupe]) {
            delete this.data.fiches[matiere][groupe];
            await this.saveData();
            return { success: true };
        }
        return { success: false };
    }
    
    async search_fiches(query) {
        const results = [];
        const lowerQuery = query.toLowerCase();
        
        Object.keys(this.data.fiches).forEach(matiere => {
            Object.keys(this.data.fiches[matiere]).forEach(groupe => {
                const ficheData = this.data.fiches[matiere][groupe];
                
                if (groupe.toLowerCase().includes(lowerQuery)) {
                    results.push({ matiere, groupe, type: 'title' });
                }
                
                ficheData.texts.forEach(text => {
                    if (text.title.toLowerCase().includes(lowerQuery) || 
                        text.content.toLowerCase().includes(lowerQuery)) {
                        results.push({ matiere, groupe, type: 'text', text: text });
                    }
                });
            });
        });
        
        return results;
    }
    
    async add_important_date(date, title, description, matiere = null) {
        if (!this.data.important_dates[date]) {
            this.data.important_dates[date] = [];
        }
        
        this.data.important_dates[date].push({
            title: title,
            description: description,
            matiere: matiere
        });
        
        await this.saveData();
        return { success: true };
    }
    
    async remove_important_date(date, index) {
        if (this.data.important_dates[date] && this.data.important_dates[date][index]) {
            this.data.important_dates[date].splice(index, 1);
            if (this.data.important_dates[date].length === 0) {
                delete this.data.important_dates[date];
            }
            await this.saveData();
            return { success: true };
        }
        return { success: false };
    }
    
    async add_manual_xp(matiere, xp, note) {
        if (this.data.matieres[matiere]) {
            this.data.matieres[matiere].xp += xp;
            this.data.matieres[matiere].level = Math.floor(this.data.matieres[matiere].xp / 100) + 1;
            this.data.total_xp += xp;
            this.data.level = Math.floor(this.data.total_xp / 500) + 1;
            await this.saveData();
            return { success: true };
        }
        return { success: false };
    }
    
    get_motivation_quote() {
        const quotes = [
            "Le succès, c'est tomber sept fois et se relever huit. - Proverbe japonais",
            "L'éducation est l'arme la plus puissante pour changer le monde. - Nelson Mandela",
            "La seule façon de faire du bon travail est d'aimer ce que vous faites. - Steve Jobs",
            "Le génie, c'est 1% d'inspiration et 99% de transpiration. - Thomas Edison",
            "Celui qui déplace une montagne commence par déplacer de petites pierres. - Confucius",
            "Le savoir que l'on ne complète pas chaque jour diminue tous les jours. - Proverbe chinois"
        ];
        return quotes[Math.floor(Math.random() * quotes.length)];
    }
    
    update_objectives() {
        // Update objectives based on current progress
        this.data.objectives.forEach(obj => {
            if (obj.matiere && this.data.matieres[obj.matiere]) {
                obj.current_value = this.data.matieres[obj.matiere].temps_total;
            }
            obj.completed = obj.current_value >= obj.target_value;
        });
    }
}

// Créer l'instance de l'API
const pywebview = {
    api: new StudyGameAPI()
};

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', async function() {
    await pywebview.api.loadData();
    if (typeof init === 'function') {
        init();
    }
});


        // Variables globales
        let currentMonth = new Date();
        let timerInterval = null;
        let timerRunning = false;
        let timerSeconds = 25 * 60;
        let currentTimerType = 'Pomodoro';
        let currentSessionKey = null;
        let focusMode = false;
        let mobileMenuOpen = false;
        
        let currentFicheMatiere = null;
        let currentFicheGroupe = null;
        let currentImageIndex = null;
        
        let currentCoursMatiere = null;
        let currentCoursGroupe = null;
        
        let xpChartInstance = null;
        let matiereChartInstance = null;
        let weeklyChartInstance = null;
        
        // MOBILE MENU
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger');
            
            mobileMenuOpen = !mobileMenuOpen;
            
            if (mobileMenuOpen) {
                sidebar.classList.remove('mobile-hidden');
                hamburger.classList.add('active');
            } else {
                sidebar.classList.add('mobile-hidden');
                hamburger.classList.remove('active');
            }
        }
        
        // Close mobile menu when clicking on a nav item
        function closeMobileMenuOnNav() {
            if (window.innerWidth <= 768 && mobileMenuOpen) {
                toggleMobileMenu();
            }
        }
        
        // FOCUS MODE
        function exitFocusMode() {
            focusMode = false;
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger');
            
            // Retirer l'overlay du mode focus
            if (focusOverlay) {
                document.body.removeChild(focusOverlay);
                focusOverlay = null;
            }
            
            // Restore UI - retirer le style inline pour que le CSS reprenne le contrôle
            sidebar.style.display = 'flex';
            if (hamburger) hamburger.style.display = ''; // Retirer le style inline
            
            // Redémarrer le timer s'il était en cours
            if (timerRunning) {
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (timerSeconds > 0) {
                        timerSeconds--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        timerRunning = false;
                        showNotification('⏰ Timer terminé !');
                    }
                }, 1000);
            }
            
            // Mettre à jour l'affichage du timer
            updateTimerDisplay();
        }
        
        // Init
        window.addEventListener('pywebviewready', function() {
            console.log('PyWebView ready, loading data...');
            initApp();
        });
        
        async function initApp() {
            try {
                // Cacher la sidebar seulement sur mobile au démarrage
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.add('mobile-hidden');
                    }
                }
                
                await loadData();
                await loadMotivationQuote();
                setupModalCloseListeners();
                console.log('App initialized successfully!');
            } catch (error) {
                console.error('Error initializing app:', error);
                // Continue même en cas d'erreur
                setupModalCloseListeners();
            }
        }
        
        function setupModalCloseListeners() {
            const modals = [
                'imageModal', 'addFicheGroupeModal', 'addTextModal', 'addTagModal',
                'addObjectiveModal', 'addImportantDateModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.classList.remove('show');
                        }
                    });
                }
            });
        }
        
        async function loadData() {
            try {
                const data = await pywebview.api.get_data();
            
            // Update sidebar
            document.getElementById('userTitle').textContent = data.title;
            document.getElementById('sidebarLevel').textContent = data.level;
            document.getElementById('sidebarXP').textContent = data.total_xp;
            document.getElementById('comboDays').textContent = data.combo_days;
            
            // Update dashboard
            document.getElementById('globalLevel').textContent = data.level;
            document.getElementById('totalXP').textContent = data.total_xp;
            document.getElementById('totalSessions').textContent = data.sessions.length;
            
            const totalMinutes = Object.values(data.matieres).reduce((sum, m) => sum + m.temps_total, 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('totalTime').textContent = `${hours}h${minutes}m`;
            
            // Matières stats
            const statsDiv = document.getElementById('matiereStats');
            const matiereStats = Object.entries(data.matieres).sort((a, b) => b[1].xp - a[1].xp);
            
            let statsHTML = '<div class="matiere-grid">';
            matiereStats.forEach(([nom, m]) => {
                const h = Math.floor(m.temps_total / 60);
                const min = m.temps_total % 60;
                statsHTML += `
                    <div class="matiere-card">
                        <div class="matiere-name">${nom}</div>
                        <div class="matiere-stat"><span>Niveau</span><span>${m.level}</span></div>
                        <div class="matiere-stat"><span>XP</span><span>${m.xp}</span></div>
                        <div class="matiere-stat"><span>Temps</span><span>${h}h${min}m</span></div>
                    </div>
                `;
            });
            statsHTML += '</div>';
            statsDiv.innerHTML = statsHTML;
            
            // Sessions récentes
            const sessionList = document.getElementById('sessionList');
            sessionList.innerHTML = '';
            const recentSessions = data.sessions.slice(-20).reverse();
            
            recentSessions.forEach(session => {
                const date = new Date(session.date);
                const startTime = session.start_time ? new Date(session.start_time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '';
                const endTime = session.end_time ? new Date(session.end_time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '';
                const timeRange = startTime && endTime ? ` (${startTime} - ${endTime})` : '';
                const comboBonus = session.combo_bonus ? ` +${Math.round(session.combo_bonus * 100)}% combo` : '';
                
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-item';
                sessionDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">${session.matiere}</div>
                    <div style="color: var(--text-secondary); font-size: 14px;">${session.type} - ${session.duree} min - +${session.xp} XP${comboBonus}${timeRange}</div>
                    <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">${date.toLocaleString('fr-FR')}</div>
                `;
                sessionList.appendChild(sessionDiv);
            });
            
            // Achievements
            updateAchievements(data);
            
            // Quests
            updateQuests(data);
            
            // Objectives
            updateObjectives(data);
            
            // Calendar
            updateCalendar();
            
            // Matière selectors
            loadMatiereSelectors(data);
            
            // Settings
            updateSettingsUI(data);
            
            // Stats
            updateStats(data);
            
            // Update global XP bar
            const xpForNextLevel = data.level * 500;
            const currentLevelXP = data.total_xp % 500;
            updateGlobalXPBar(currentLevelXP, 500);
            
            // Animate counters on dashboard
            const globalLevelEl = document.getElementById('globalLevel');
            const totalXPEl = document.getElementById('totalXP');
            const totalSessionsEl = document.getElementById('totalSessions');
            
            if (globalLevelEl && !globalLevelEl.dataset.animated) {
                animateCounter(globalLevelEl, data.level, 800);
                globalLevelEl.dataset.animated = 'true';
            }
            if (totalXPEl && !totalXPEl.dataset.animated) {
                animateCounter(totalXPEl, data.total_xp, 1200);
                totalXPEl.dataset.animated = 'true';
            }
            if (totalSessionsEl && !totalSessionsEl.dataset.animated) {
                animateCounter(totalSessionsEl, data.sessions.length, 1000);
                totalSessionsEl.dataset.animated = 'true';
            }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('❌ Erreur de chargement des données', 'error');
            }
        }
        
        async function loadMotivationQuote() {
            try {
                const quote = await pywebview.api.get_motivation_quote();
                document.getElementById('quoteCard').textContent = quote;
            } catch (error) {
                console.error('Error loading quote:', error);
                document.getElementById('quoteCard').textContent = "Le succès n'est pas final, l'échec n'est pas fatal.";
            }
        }
        
        function updateAchievements(data) {
            const achievementsList = document.getElementById('achievementsList');
            const achievementCount = document.getElementById('achievementCount');
            const badgesList = document.getElementById('badgesList');
            
            achievementsList.innerHTML = '';
            const sortedAchievements = [...data.achievements].reverse();
            
            sortedAchievements.forEach(achievement => {
                const date = new Date(achievement.date);
                const achDiv = document.createElement('div');
                achDiv.className = 'achievement-card';
                achDiv.innerHTML = `
                    <div class="achievement-icon">${achievement.title.split(' ')[0]}</div>
                    <div class="achievement-content">
                        <h3>${achievement.title}</h3>
                        <p>${achievement.description}</p>
                        <p style="font-size: 12px; margin-top: 8px;">${date.toLocaleDateString('fr-FR')}</p>
                    </div>
                `;
                achievementsList.appendChild(achDiv);
            });
            
            achievementCount.textContent = `${data.achievements.length} succès débloqués`;
            
            // Badges
            badgesList.innerHTML = '';
            data.badges.forEach(badge => {
                const date = new Date(badge.date);
                const badgeDiv = document.createElement('div');
                badgeDiv.className = `badge-card ${badge.tier}`;
                badgeDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 12px;">${badge.name.split(' ')[0]}</div>
                    <h3 style="margin-bottom: 8px;">${badge.name}</h3>
                    <p>${badge.description}</p>
                    <p style="font-size: 12px; margin-top: 12px; opacity: 0.9;">${date.toLocaleDateString('fr-FR')}</p>
                `;
                badgesList.appendChild(badgeDiv);
            });
        }
        
        function updateQuests(data) {
            const questsList = document.getElementById('questsList');
            questsList.innerHTML = '';
            
            if (!data.daily_quests || data.daily_quests.length === 0) {
                questsList.innerHTML = '<p style="color: var(--text-secondary);">Aucune quête disponible</p>';
                return;
            }
            
            data.daily_quests.forEach(quest => {
                const progress = Math.min((quest.current / quest.target) * 100, 100);
                const questDiv = document.createElement('div');
                questDiv.className = 'quest-card' + (quest.completed ? ' completed' : '');
                questDiv.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div>${quest.description}</div>
                    <div class="progress-bar" style="margin-top: 12px;">
                        <div class="progress-fill" style="width: ${progress}%">${quest.current} / ${quest.target}</div>
                    </div>
                    <div class="quest-reward">${quest.completed ? '✅ Complété' : `🎁 ${quest.xp_reward} XP`}</div>
                `;
                questsList.appendChild(questDiv);
            });
        }
        
        function updateObjectives(data) {
            pywebview.api.update_objectives();
            
            const objectivesList = document.getElementById('objectivesList');
            objectivesList.innerHTML = '';
            
            if (!data.objectives || data.objectives.length === 0) {
                objectivesList.innerHTML = '<p style="color: var(--text-secondary);">Aucun objectif défini. Crée ton premier objectif !</p>';
                return;
            }
            
            data.objectives.forEach(obj => {
                const progress = Math.min((obj.current_value / obj.target_value) * 100, 100);
                const objDiv = document.createElement('div');
                objDiv.className = 'objective-card';
                objDiv.innerHTML = `
                    <div class="objective-header">
                        <div class="objective-title">${obj.title}</div>
                        <button class="delete-btn" onclick="deleteObjective(${obj.id})">🗑️</button>
                    </div>
                    <div class="objective-desc">${obj.description}</div>
                    ${obj.matiere ? `<div style="color: var(--accent-blue); font-size: 14px; margin-bottom: 8px;">📚 ${obj.matiere}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%">${obj.current_value} / ${obj.target_value}</div>
                    </div>
                    ${obj.completed ? '<div style="color: var(--accent-green); font-weight: 600; margin-top: 8px;">✅ Objectif atteint !</div>' : ''}
                `;
                objectivesList.appendChild(objDiv);
            });
        }
        
        function updateCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(day => {
                const dayLabel = document.createElement('div');
                dayLabel.style.textAlign = 'center';
                dayLabel.style.fontWeight = '600';
                dayLabel.style.color = 'var(--text-secondary)';
                dayLabel.textContent = day;
                grid.appendChild(dayLabel);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            for (let i = 0; i < startDay; i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            Promise.all([
                pywebview.api.get_calendar_month(year, month + 1),
                pywebview.api.get_data()
            ]).then(([calendar, data]) => {
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.onclick = () => showDayDetails(dateStr, calendar[dateStr] || [], data.important_dates[dateStr] || []);
                    
                    // Important date
                    if (data.important_dates[dateStr]) {
                        dayDiv.classList.add('important-date');
                    }
                    
                    if (calendar[dateStr]) {
                        dayDiv.classList.add('has-session');
                        const sessions = calendar[dateStr];
                        const totalTime = sessions.reduce((sum, s) => sum + s.duree, 0);
                        
                        let hoursText = '';
                        sessions.forEach(s => {
                            if (s.start_time && s.end_time) {
                                hoursText += `<div style="font-size: 9px; margin-top: 2px;">${s.start_time}-${s.end_time}</div>`;
                            }
                        });
                        
                        dayDiv.innerHTML = `<div>${day}</div><div style="font-size: 10px;">${totalTime}min</div>${hoursText}`;
                    } else {
                        dayDiv.textContent = day;
                    }
                    
                    grid.appendChild(dayDiv);
                }
            });
        }
        
        function showDayDetails(dateStr, sessions, importantDates) {
            const detailsDiv = document.getElementById('dayDetails');
            const titleDiv = document.getElementById('dayDetailsTitle');
            const contentDiv = document.getElementById('dayDetailsContent');
            
            const date = new Date(dateStr);
            titleDiv.textContent = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            let html = '';
            
            if (importantDates && importantDates.length > 0) {
                html += '<h4 style="margin-top: 16px; margin-bottom: 12px;">📌 Dates Importantes</h4>';
                importantDates.forEach((event, index) => {
                    html += `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--accent-red); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">${event.title}</div>
                            <div style="color: var(--text-secondary); margin-bottom: 8px;">${event.description}</div>
                            ${event.matiere ? `<div style="color: var(--accent-blue); font-size: 14px;">📚 ${event.matiere}</div>` : ''}
                            <button class="delete-btn" style="margin-top: 8px;" onclick="removeImportantDate('${dateStr}', ${index})">🗑️ Supprimer</button>
                        </div>
                    `;
                });
            }
            
            if (sessions && sessions.length > 0) {
                html += '<h4 style="margin-top: 16px; margin-bottom: 12px;">📚 Sessions</h4>';
                sessions.forEach(session => {
                    html += `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${session.matiere}</div>
                            <div style="color: var(--text-secondary);">${session.type} - ${session.duree} min</div>
                            ${session.start_time && session.end_time ? `<div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">${session.start_time} - ${session.end_time}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (!importantDates || importantDates.length === 0) {
                if (!sessions || sessions.length === 0) {
                    html = '<p style="color: var(--text-secondary); margin-top: 16px;">Aucune activité ce jour-là</p>';
                }
            }
            
            contentDiv.innerHTML = html;
            detailsDiv.style.display = 'block';
        }
        
        function changeMonth(delta) {
            if (delta === 0) {
                currentMonth = new Date();
            } else {
                currentMonth.setMonth(currentMonth.getMonth() + delta);
            }
            updateCalendar();
        }
        
        function loadMatiereSelectors(data) {
            const ficheMatiereSelector = document.getElementById('ficheMatiereSelector');
            const coursMatiereSelector = document.getElementById('coursMatiereSelector');
            
            ficheMatiereSelector.innerHTML = '';
            
            Object.keys(data.matieres).forEach(matiere => {
                const ficheBtn = document.createElement('button');
                ficheBtn.className = 'matiere-btn';
                ficheBtn.textContent = matiere;
                ficheBtn.onclick = () => selectFicheMatiere(matiere);
                ficheMatiereSelector.appendChild(ficheBtn);
            });
        }
        
        function updateSettingsUI(data) {
            // Theme
            document.body.setAttribute('data-theme', data.theme);
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === data.theme) {
                    btn.classList.add('active');
                }
            });
            
            // Sounds
            const soundsToggle = document.getElementById('soundsToggle');
            if (data.sounds_enabled) {
                soundsToggle.classList.add('active');
            } else {
                soundsToggle.classList.remove('active');
            }
        }
        
        async function updateStats(data) {
            const stats = await pywebview.api.get_statistics();
            
            document.getElementById('statsWeekSessions').textContent = stats.sessions_week;
            document.getElementById('statsWeekTime').textContent = `${Math.floor(stats.time_week / 60)}h`;
            document.getElementById('statsMonthTime').textContent = `${Math.floor(stats.time_month / 60)}h`;
            document.getElementById('statsAvgSession').textContent = `${stats.avg_session}min`;
            document.getElementById('statsBestPeriod').textContent = stats.best_period;
            document.getElementById('statsMaxCombo').textContent = data.combo_days;
            
            // Charts
            createXPChart(data);
            createMatiereChart(data);
            createWeeklyChart(data);
        }
        
        function createXPChart(data) {
            const ctx = document.getElementById('xpChart');
            if (!ctx) return;
            
            // Préparer les données
            const last30Days = [];
            const xpData = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last30Days.push(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
                
                const dayXP = data.sessions
                    .filter(s => s.date.split('T')[0] === dateStr)
                    .reduce((sum, s) => sum + s.xp, 0);
                xpData.push(dayXP);
            }
            
            if (xpChartInstance) {
                xpChartInstance.destroy();
            }
            
            xpChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30Days,
                    datasets: [{
                        label: 'XP Gagné',
                        data: xpData,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        }
                    }
                }
            });
        }
        
        function createMatiereChart(data) {
            const ctx = document.getElementById('matiereChart');
            if (!ctx) return;
            
            const matieres = Object.keys(data.matieres);
            const times = matieres.map(m => data.matieres[m].temps_total);
            
            const colors = [
                '#58a6ff', '#79c0ff', '#a5d6ff', '#c9e6ff',
                '#f97316', '#fb923c', '#fdba74', '#fed7aa',
                '#22c55e', '#4ade80'
            ];
            
            if (matiereChartInstance) {
                matiereChartInstance.destroy();
            }
            
            matiereChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: matieres,
                    datasets: [{
                        data: times,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e6edf3'
                            }
                        }
                    }
                }
            });
        }
        
        function createWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;
            
            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            const weekData = [0, 0, 0, 0, 0, 0, 0];
            
            data.sessions.forEach(session => {
                const date = new Date(session.date);
                const dayOfWeek = date.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                weekData[adjustedDay] += session.duree;
            });
            
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
            }
            
            weeklyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Minutes',
                        data: weekData,
                        backgroundColor: '#238636'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        }
                    }
                }
            });
        }
        
        // TIMER FUNCTIONS
        function setTimer(minutes, type) {
            timerSeconds = minutes * 60;
            currentTimerType = type;
            updateTimerDisplay();
            
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            document.getElementById('timerDisplay').textContent = display;
            if (focusMode) {
                document.querySelector('.focus-timer-display').textContent = display;
            }
        }
        
        async function startTimer() {
            if (timerRunning) return;
            
            const matiere = document.getElementById('timerMatiere').value;
            const result = await pywebview.api.start_session(matiere, currentTimerType);
            currentSessionKey = result.session_key;
            
            timerRunning = true;
            timerInterval = setInterval(() => {
                if (timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                } else {
                    pauseTimer();
                    showNotification('⏰ Timer terminé!');
                    if (focusMode) {
                        exitFocusMode();
                    }
                }
            }, 1000);
        }
        
        function pauseTimer() {
            timerRunning = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function resetTimer() {
            pauseTimer();
            currentSessionKey = null;
            if (currentTimerType === 'Pomodoro') timerSeconds = 25 * 60;
            else if (currentTimerType === 'Flash') timerSeconds = 15 * 60;
            else if (currentTimerType === 'Intensif') timerSeconds = 45 * 60;
            else if (currentTimerType === 'Deep Work') timerSeconds = 90 * 60;
            else if (currentTimerType === 'Pause') timerSeconds = 5 * 60;
            updateTimerDisplay();
        }
        
        async function finishSession() {
            const matiere = document.getElementById('timerMatiere').value;
            
            let timeSpent = 0;
            if (currentTimerType === 'Pomodoro') timeSpent = 25;
            else if (currentTimerType === 'Flash') timeSpent = 15;
            else if (currentTimerType === 'Intensif') timeSpent = 45;
            else if (currentTimerType === 'Deep Work') timeSpent = 90;
            else if (currentTimerType === 'Pause') timeSpent = 5;
            
            const xpGained = timeSpent * 2;
            
            try {
                const data = await pywebview.api.get_data();
                const oldLevel = data.level;
                
                const result = await pywebview.api.add_session(matiere, currentTimerType, timeSpent, xpGained, currentSessionKey);
                
                if (result.success) {
                    // Show success notification with confetti
                    createConfetti(30);
                    
                    let message = `✅ +${xpGained} XP gagné!`;
                    if (result.combo_bonus > 0) {
                        message += ` 🔥 +${Math.round(result.combo_bonus * 100)}% bonus combo!`;
                    }
                    showNotification(message, 'success');
                    
                    // Check for level up
                    if (result.new_level > oldLevel) {
                        setTimeout(() => {
                            showLevelUpAnimation(result.new_level);
                        }, 500);
                    }
                    
                    // Show achievements
                    if (result.achievements && result.achievements.length > 0) {
                        result.achievements.forEach((achievement, index) => {
                            setTimeout(() => {
                                showAchievementPopup('Succès débloqué!', achievement);
                            }, 1000 + (index * 500));
                        });
                    }
                    
                    // Show badges
                    if (result.badges && result.badges.length > 0) {
                        result.badges.forEach((badge, index) => {
                            setTimeout(() => {
                                showAchievementPopup('Nouveau Badge!', badge);
                            }, 1500 + (index * 500));
                        });
                    }
                    
                    await loadData();
                    resetTimer();
                    if (focusMode) {
                        exitFocusMode();
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('❌ Erreur lors de l\'enregistrement', 'error');
            }
        }
        
        async function addManualXP() {
            const matiere = document.getElementById('timerMatiere').value;
            const xp = parseInt(document.getElementById('manualXP').value);
            const note = document.getElementById('manualNote').value || 'XP Manuel';
            
            if (xp <= 0) {
                showNotification('⚠️ XP invalide');
                return;
            }
            
            try {
                await pywebview.api.add_manual_xp(matiere, xp, note);
                showNotification(`✅ +${xp} XP ajouté!`);
                await loadData();
                document.getElementById('manualNote').value = '';
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('❌ Erreur');
            }
        }
        
        let focusOverlay = null;
        
        function toggleFocusMode() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger');
            
            if (!focusMode) {
                focusMode = true;
                
                // Save current state
                const currentTime = document.getElementById('timerDisplay').textContent;
                const currentMatiere = document.getElementById('timerMatiere').value;
                
                // Hide sidebar and hamburger
                sidebar.style.display = 'none';
                if (hamburger) hamburger.style.display = 'none';
                
                // Créer un overlay pour le mode focus au lieu de remplacer le contenu
                focusOverlay = document.createElement('div');
                focusOverlay.id = 'focusOverlay';
                focusOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: var(--bg-primary);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                focusOverlay.innerHTML = `
                    <div class="focus-mode-container">
                        <div class="focus-timer">
                            <h1 style="font-size: 48px; margin-bottom: 20px;">Mode Focus 🎯</h1>
                            <div class="focus-timer-display">${currentTime}</div>
                            <div style="font-size: 24px; margin-top: 20px;">${currentMatiere}</div>
                            <div style="font-size: 18px; margin-top: 10px; opacity: 0.8;">${currentTimerType}</div>
                        </div>
                    </div>
                    <button class="focus-exit" onclick="exitFocusMode()">✕ Quitter</button>
                `;
                document.body.appendChild(focusOverlay);
                
                // Continue timer in focus mode if running
                if (timerRunning) {
                    // IMPORTANT: Arrêter l'ancien interval avant d'en créer un nouveau
                    clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                        if (timerSeconds > 0) {
                            timerSeconds--;
                            updateTimerDisplay();
                        } else {
                            clearInterval(timerInterval);
                            timerRunning = false;
                            showNotification('⏰ Timer terminé !');
                        }
                    }, 1000);
                }
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const timerDisplay = document.getElementById('timerDisplay');
            const focusDisplay = document.querySelector('.focus-timer-display');
            
            if (timerDisplay) timerDisplay.textContent = display;
            if (focusDisplay) focusDisplay.textContent = display;
        }
        
        // FICHES FUNCTIONS
        async function selectFicheMatiere(matiere) {
            currentFicheMatiere = matiere;
            const data = await pywebview.api.get_data();
            
            document.getElementById('ficheMainView').style.display = 'none';
            document.getElementById('ficheGroupeView').style.display = 'block';
            document.getElementById('currentFicheMatiereName').textContent = matiere;
            
            const groupesList = document.getElementById('ficheGroupesList');
            groupesList.innerHTML = '';
            
            if (data.fiches[matiere]) {
                Object.entries(data.fiches[matiere]).forEach(([nom, groupe]) => {
                    const key = `${matiere}::${nom}`;
                    const tags = data.tags[key] || [];
                    const isFavorite = data.favorites.includes(key);
                    
                    const card = document.createElement('div');
                    card.className = 'groupe-card' + (isFavorite ? ' favorite' : '');
                    card.onclick = () => selectFicheGroupe(nom);
                    card.innerHTML = `
                        <div class="groupe-name">${nom}</div>
                        <div class="groupe-info">${groupe.images.length} image(s) • ${groupe.texts?.length || 0} texte(s)</div>
                        ${tags.length > 0 ? `
                            <div class="tags-container">
                                ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    `;
                    groupesList.appendChild(card);
                });
            }
        }
        
        async function selectFicheGroupe(groupe) {
            currentFicheGroupe = groupe;
            const data = await pywebview.api.get_data();
            
            document.getElementById('ficheGroupeView').style.display = 'none';
            document.getElementById('ficheContentView').style.display = 'block';
            document.getElementById('currentFicheGroupeName').textContent = `${currentFicheMatiere} - ${groupe}`;
            
            loadFicheImages(data);
            loadFicheTexts(data);
        }
        
        // Configuration de marked.js pour gérer les formules mathématiques
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // Fonction pour rendre les mathématiques avec KaTeX
        function renderMath(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false,
                    trust: true,
                    strict: false
                });
            }
        }
        
        function loadFicheImages(data) {
            const imagesList = document.getElementById('ficheImagesList');
            imagesList.innerHTML = '';
            
            if (data.fiches[currentFicheMatiere] && data.fiches[currentFicheMatiere][currentFicheGroupe]) {
                const images = data.fiches[currentFicheMatiere][currentFicheGroupe].images;
                images.forEach((img, index) => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    card.onclick = () => openImageModal(index, 'fiche');
                    card.innerHTML = `
                        <img src="${img.data}" alt="${img.nom}">
                        <div class="image-info">
                            <div class="image-name">${img.nom}</div>
                            <div class="image-date">${new Date(img.date_ajout).toLocaleDateString('fr-FR')}</div>
                        </div>
                    `;
                    imagesList.appendChild(card);
                });
            }
        }
        
        function loadFicheTexts(data) {
            const textsList = document.getElementById('ficheTextsList');
            textsList.innerHTML = '';
            
            if (data.fiches[currentFicheMatiere] && data.fiches[currentFicheMatiere][currentFicheGroupe]) {
                const texts = data.fiches[currentFicheMatiere][currentFicheGroupe].texts || [];
                texts.forEach(text => {
                    const card = document.createElement('div');
                    card.className = 'text-card';
                    
                    // Render markdown using marked.js
                    const htmlContent = marked.parse(text.content);
                    
                    card.innerHTML = `
                        <div class="text-title">${text.title}</div>
                        <div class="text-content markdown-content">${htmlContent}</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 12px;">${new Date(text.date_ajout).toLocaleDateString('fr-FR')}</div>
                    `;
                    textsList.appendChild(card);
                    
                    // Rendre les formules mathématiques après l'ajout au DOM
                    setTimeout(() => {
                        const contentDiv = card.querySelector('.markdown-content');
                        if (contentDiv) {
                            renderMath(contentDiv);
                        }
                    }, 100);
                });
            }
        }
        
        function switchFicheTab(tab) {
            document.querySelectorAll('#ficheContentView .tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if (tab === 'images') {
                document.getElementById('ficheImagesTab').style.display = 'block';
                document.getElementById('ficheTextsTab').style.display = 'none';
            } else {
                document.getElementById('ficheImagesTab').style.display = 'none';
                document.getElementById('ficheTextsTab').style.display = 'block';
            }
        }
        
        function backToFicheMatieres() {
            currentFicheMatiere = null;
            currentFicheGroupe = null;
            document.getElementById('ficheGroupeView').style.display = 'none';
            document.getElementById('ficheContentView').style.display = 'none';
            document.getElementById('ficheMainView').style.display = 'block';
        }
        
        function backToFicheGroupes() {
            currentFicheGroupe = null;
            document.getElementById('ficheContentView').style.display = 'none';
            document.getElementById('ficheGroupeView').style.display = 'block';
            selectFicheMatiere(currentFicheMatiere);
        }
        
        function showAddFicheGroupeModal() {
            document.getElementById('addFicheGroupeModal').classList.add('show');
        }
        
        function closeAddFicheGroupeModal() {
            document.getElementById('addFicheGroupeModal').classList.remove('show');
            document.getElementById('newFicheGroupeName').value = '';
        }
        
        async function createFicheGroupe() {
            const nom = document.getElementById('newFicheGroupeName').value.trim();
            if (!nom) {
                showNotification('⚠️ Nom invalide');
                return;
            }
            
            const result = await pywebview.api.create_fiche_groupe(currentFicheMatiere, nom);
            if (result.success) {
                showNotification('✅ Chapitre créé!');
                closeAddFicheGroupeModal();
                selectFicheMatiere(currentFicheMatiere);
            } else {
                showNotification('❌ ' + result.error);
            }
        }
        
        async function uploadFicheImages() {
            const input = document.getElementById('ficheImageUpload');
            const files = input.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    const result = await pywebview.api.add_image_to_groupe(
                        currentFicheMatiere, 
                        currentFicheGroupe, 
                        e.target.result, 
                        file.name
                    );
                    
                    if (result.success) {
                        showNotification(`✅ ${file.name} ajouté!`);
                        const data = await pywebview.api.get_data();
                        loadFicheImages(data);
                    }
                };
                
                reader.readAsDataURL(file);
            }
            
            input.value = '';
        }
        
        function showAddTextModal() {
            document.getElementById('addTextModal').classList.add('show');
        }
        
        function closeAddTextModal() {
            document.getElementById('addTextModal').classList.remove('show');
            document.getElementById('newTextTitle').value = '';
            document.getElementById('newTextContent').value = '';
        }
        
        async function addTextFiche() {
            const title = document.getElementById('newTextTitle').value.trim();
            const content = document.getElementById('newTextContent').value.trim();
            
            if (!title || !content) {
                showNotification('⚠️ Titre et contenu requis');
                return;
            }
            
            const result = await pywebview.api.add_text_to_groupe(currentFicheMatiere, currentFicheGroupe, title, content);
            if (result.success) {
                showNotification('✅ Texte ajouté!');
                closeAddTextModal();
                const data = await pywebview.api.get_data();
                loadFicheTexts(data);
            }
        }
        
        async function toggleFicheFavorite() {
            const result = await pywebview.api.toggle_favorite(currentFicheMatiere, currentFicheGroupe);
            if (result.success) {
                showNotification(result.is_favorite ? '⭐ Ajouté aux favoris' : '☆ Retiré des favoris');
                selectFicheMatiere(currentFicheMatiere);
            }
        }
        
        function showAddTagModal() {
            document.getElementById('addTagModal').classList.add('show');
        }
        
        function closeAddTagModal() {
            document.getElementById('addTagModal').classList.remove('show');
            document.getElementById('newTag').value = '';
        }
        
        async function addTag() {
            const tag = document.getElementById('newTag').value.trim();
            if (!tag) {
                showNotification('⚠️ Tag invalide');
                return;
            }
            
            const result = await pywebview.api.add_tag(currentFicheMatiere, currentFicheGroupe, tag);
            if (result.success) {
                showNotification('✅ Tag ajouté!');
                closeAddTagModal();
                // Rester sur l'interface actuelle
                selectFicheGroupe(currentFicheGroupe);
            }
        }
        
        async function deleteFicheGroupe() {
            if (!confirm('Supprimer ce chapitre et tout son contenu ?')) return;
            
            const result = await pywebview.api.delete_fiche_groupe(currentFicheMatiere, currentFicheGroupe);
            if (result.success) {
                showNotification('✅ Chapitre supprimé!');
                backToFicheGroupes();
            }
        }
        
        async function searchFiches() {
            const query = document.getElementById('ficheSearch').value.trim();
            
            if (query.length === 0) {
                clearFicheSearch();
                return;
            }
            
            const results = await pywebview.api.search_fiches(query);
            
            document.getElementById('ficheMainView').style.display = 'none';
            document.getElementById('ficheGroupeView').style.display = 'none';
            document.getElementById('ficheContentView').style.display = 'none';
            document.getElementById('ficheSearchResults').style.display = 'block';
            
            const resultsList = document.getElementById('ficheSearchResultsList');
            resultsList.innerHTML = '';
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p style="color: var(--text-secondary);">Aucun résultat trouvé</p>';
            } else {
                results.forEach(result => {
                    const card = document.createElement('div');
                    card.className = 'groupe-card' + (result.is_favorite ? ' favorite' : '');
                    card.onclick = () => {
                        currentFicheMatiere = result.matiere;
                        clearFicheSearch();
                        selectFicheMatiere(result.matiere);
                        setTimeout(() => selectFicheGroupe(result.groupe), 100);
                    };
                    card.innerHTML = `
                        <div class="groupe-name">${result.matiere} - ${result.groupe}</div>
                        <div class="groupe-info">${result.nb_images} image(s) • ${result.nb_texts} texte(s)</div>
                        ${result.tags.length > 0 ? `
                            <div class="tags-container">
                                ${result.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    `;
                    resultsList.appendChild(card);
                });
            }
        }
        
        function clearFicheSearch() {
            document.getElementById('ficheSearch').value = '';
            document.getElementById('ficheSearchResults').style.display = 'none';
            document.getElementById('ficheMainView').style.display = 'block';
        }
        
        // COURS FUNCTIONS
        async function selectCoursMatiere(matiere) {
            currentCoursMatiere = matiere;
            const data = await pywebview.api.get_data();
            
            document.getElementById('coursMainView').style.display = 'none';
            document.getElementById('coursGroupeView').style.display = 'block';
            document.getElementById('currentCoursMatiereName').textContent = matiere;
            
            const groupesList = document.getElementById('coursGroupesList');
            groupesList.innerHTML = '';
            
            if (data.cours[matiere]) {
                Object.entries(data.cours[matiere]).forEach(([nom, groupe]) => {
                    const card = document.createElement('div');
                    card.className = 'groupe-card';
                    card.onclick = () => selectCoursGroupe(nom);
                    card.innerHTML = `
                        <div class="groupe-name">${nom}</div>
                        <div class="groupe-info">${groupe.files?.length || 0} fichier(s) • ${groupe.notes?.length || 0} note(s)</div>
                    `;
                    groupesList.appendChild(card);
                });
            }
        }
        
        async function selectCoursGroupe(groupe) {
            currentCoursGroupe = groupe;
            const data = await pywebview.api.get_data();
            
            document.getElementById('coursGroupeView').style.display = 'none';
            document.getElementById('coursContentView').style.display = 'block';
            document.getElementById('currentCoursGroupeName').textContent = `${currentCoursMatiere} - ${groupe}`;
            
            loadCoursFiles(data);
            loadCoursNotes(data);
        }
        
        function loadCoursFiles(data) {
            const filesList = document.getElementById('coursFilesList');
            filesList.innerHTML = '';
            
            if (data.cours[currentCoursMatiere] && data.cours[currentCoursMatiere][currentCoursGroupe]) {
                const files = data.cours[currentCoursMatiere][currentCoursGroupe].files || [];
                files.forEach((file, index) => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    card.onclick = () => openImageModal(index, 'cours');
                    card.innerHTML = `
                        <img src="${file.data}" alt="${file.nom}" style="object-fit: contain; background: var(--bg-tertiary);">
                        <div class="image-info">
                            <div class="image-name">${file.nom}</div>
                            <div class="image-date">${new Date(file.date_ajout).toLocaleDateString('fr-FR')}</div>
                        </div>
                    `;
                    filesList.appendChild(card);
                });
            }
        }
        
        function loadCoursNotes(data) {
            const notesList = document.getElementById('coursNotesList');
            notesList.innerHTML = '';
            
            if (data.cours[currentCoursMatiere] && data.cours[currentCoursMatiere][currentCoursGroupe]) {
                const notes = data.cours[currentCoursMatiere][currentCoursGroupe].notes || [];
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'text-card';
                    card.innerHTML = `
                        <div class="text-title">${note.title}</div>
                        <div class="text-content">${note.content}</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 12px;">${new Date(note.date_ajout).toLocaleDateString('fr-FR')}</div>
                    `;
                    notesList.appendChild(card);
                });
            }
        }
        
        function switchCoursTab(tab) {
            document.querySelectorAll('#coursContentView .tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if (tab === 'files') {
                document.getElementById('coursFilesTab').style.display = 'block';
                document.getElementById('coursNotesTab').style.display = 'none';
            } else {
                document.getElementById('coursFilesTab').style.display = 'none';
                document.getElementById('coursNotesTab').style.display = 'block';
            }
        }
        
        function backToCoursMatieres() {
            currentCoursMatiere = null;
            currentCoursGroupe = null;
            document.getElementById('coursGroupeView').style.display = 'none';
            document.getElementById('coursContentView').style.display = 'none';
            document.getElementById('coursMainView').style.display = 'block';
        }
        
        function backToCoursGroupes() {
            currentCoursGroupe = null;
            document.getElementById('coursContentView').style.display = 'none';
            document.getElementById('coursGroupeView').style.display = 'block';
            selectCoursMatiere(currentCoursMatiere);
        }
        
        function showAddCoursGroupeModal() {
            document.getElementById('addCoursGroupeModal').classList.add('show');
        }
        
        function closeAddCoursGroupeModal() {
            document.getElementById('addCoursGroupeModal').classList.remove('show');
            document.getElementById('newCoursGroupeName').value = '';
        }
        
        async function createCoursGroupe() {
            const nom = document.getElementById('newCoursGroupeName').value.trim();
            if (!nom) {
                showNotification('⚠️ Nom invalide');
                return;
            }
            
            const result = await pywebview.api.create_cours_groupe(currentCoursMatiere, nom);
            if (result.success) {
                showNotification('✅ Cours créé!');
                closeAddCoursGroupeModal();
                selectCoursMatiere(currentCoursMatiere);
            } else {
                showNotification('❌ ' + result.error);
            }
        }
        
        async function uploadCoursFiles() {
            const input = document.getElementById('coursFileUpload');
            const files = input.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    const result = await pywebview.api.add_file_to_cours(
                        currentCoursMatiere, 
                        currentCoursGroupe, 
                        e.target.result, 
                        file.name
                    );
                    
                    if (result.success) {
                        showNotification(`✅ ${file.name} ajouté!`);
                        const data = await pywebview.api.get_data();
                        loadCoursFiles(data);
                    }
                };
                
                reader.readAsDataURL(file);
            }
            
            input.value = '';
        }
        
        function showAddCoursNoteModal() {
            document.getElementById('addCoursNoteModal').classList.add('show');
        }
        
        function closeAddCoursNoteModal() {
            document.getElementById('addCoursNoteModal').classList.remove('show');
            document.getElementById('newCoursNoteTitle').value = '';
            document.getElementById('newCoursNoteContent').value = '';
        }
        
        async function addCoursNote() {
            const title = document.getElementById('newCoursNoteTitle').value.trim();
            const content = document.getElementById('newCoursNoteContent').value.trim();
            
            if (!title || !content) {
                showNotification('⚠️ Titre et contenu requis');
                return;
            }
            
            const result = await pywebview.api.add_note_to_cours(currentCoursMatiere, currentCoursGroupe, title, content);
            if (result.success) {
                showNotification('✅ Note ajoutée!');
                closeAddCoursNoteModal();
                const data = await pywebview.api.get_data();
                loadCoursNotes(data);
            }
        }
        
        async function deleteCoursGroupe() {
            if (!confirm('Supprimer ce cours et tout son contenu ?')) return;
            
            const result = await pywebview.api.delete_cours_groupe(currentCoursMatiere, currentCoursGroupe);
            if (result.success) {
                showNotification('✅ Cours supprimé!');
                backToCoursGroupes();
            }
        }
        
        // OBJECTIVES FUNCTIONS
        function showAddObjectiveModal() {
            document.getElementById('addObjectiveModal').classList.add('show');
        }
        
        function closeAddObjectiveModal() {
            document.getElementById('addObjectiveModal').classList.remove('show');
            document.getElementById('objTitle').value = '';
            document.getElementById('objDescription').value = '';
            document.getElementById('objTarget').value = '';
            document.getElementById('objMatiere').value = '';
        }
        
        async function addObjective() {
            const title = document.getElementById('objTitle').value.trim();
            const description = document.getElementById('objDescription').value.trim();
            const type = document.getElementById('objType').value;
            const target = parseInt(document.getElementById('objTarget').value);
            const matiere = document.getElementById('objMatiere').value || null;
            
            if (!title || !description || !target) {
                showNotification('⚠️ Tous les champs sont requis');
                return;
            }
            
            const result = await pywebview.api.add_objective(title, description, target, type, matiere);
            if (result.success) {
                showNotification('✅ Objectif créé!');
                closeAddObjectiveModal();
                await loadData();
            }
        }
        
        async function deleteObjective(id) {
            if (!confirm('Supprimer cet objectif ?')) return;
            
            const result = await pywebview.api.delete_objective(id);
            if (result.success) {
                showNotification('✅ Objectif supprimé!');
                await loadData();
            }
        }
        
        // IMPORTANT DATES
        function showAddImportantDateModal() {
            document.getElementById('addImportantDateModal').classList.add('show');
        }
        
        function closeAddImportantDateModal() {
            document.getElementById('addImportantDateModal').classList.remove('show');
            document.getElementById('importantDate').value = '';
            document.getElementById('importantTitle').value = '';
            document.getElementById('importantDescription').value = '';
            document.getElementById('importantMatiere').value = '';
        }
        
        async function addImportantDate() {
            const date = document.getElementById('importantDate').value;
            const title = document.getElementById('importantTitle').value.trim();
            const description = document.getElementById('importantDescription').value.trim();
            const matiere = document.getElementById('importantMatiere').value || null;
            
            if (!date || !title || !description) {
                showNotification('⚠️ Tous les champs sont requis');
                return;
            }
            
            const result = await pywebview.api.add_important_date(date, title, description, matiere);
            if (result.success) {
                showNotification('✅ Date importante ajoutée!');
                closeAddImportantDateModal();
                updateCalendar();
            }
        }
        
        async function removeImportantDate(dateStr, index) {
            if (!confirm('Supprimer cette date importante ?')) return;
            
            const result = await pywebview.api.remove_important_date(dateStr, index);
            if (result.success) {
                showNotification('✅ Date supprimée!');
                updateCalendar();
                document.getElementById('dayDetails').style.display = 'none';
            }
        }
        
        // IMAGE MODAL
        let currentImageType = null;
        
        async function openImageModal(index, type) {
            currentImageIndex = index;
            currentImageType = type;
            const data = await pywebview.api.get_data();
            
            let image;
            if (type === 'fiche') {
                image = data.fiches[currentFicheMatiere][currentFicheGroupe].images[index];
            } else if (type === 'cours') {
                image = data.cours[currentCoursMatiere][currentCoursGroupe].files[index];
            }
            
            document.getElementById('modalImage').src = image.data;
            document.getElementById('imageModal').classList.add('show');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
            currentImageIndex = null;
            currentImageType = null;
        }
        
        async function deleteCurrentImage() {
            if (currentImageIndex === null) return;
            
            if (!confirm('Supprimer cette image ?')) return;
            
            let result;
            if (currentImageType === 'fiche') {
                result = await pywebview.api.delete_image_from_groupe(currentFicheMatiere, currentFicheGroupe, currentImageIndex);
            }
            
            if (result && result.success) {
                showNotification('✅ Image supprimée!');
                closeImageModal();
                const data = await pywebview.api.get_data();
                if (currentImageType === 'fiche') {
                    loadFicheImages(data);
                } else if (currentImageType === 'cours') {
                    loadCoursFiles(data);
                }
            }
        }
        
        // SETTINGS
        async function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('active');
                }
            });
            
            await pywebview.api.update_settings(theme, null);
            showNotification('✅ Thème changé!');
        }
        
        async function toggleSounds() {
            const toggle = document.getElementById('soundsToggle');
            const isActive = toggle.classList.contains('active');
            
            if (isActive) {
                toggle.classList.remove('active');
                await pywebview.api.update_settings(null, false);
            } else {
                toggle.classList.add('active');
                await pywebview.api.update_settings(null, true);
            }
            
            showNotification('✅ Paramètre mis à jour!');
        }
        
        async function backupData() {
            try {
                const result = await pywebview.api.backup_data();
                if (result.success) {
                    showNotification('✅ Backup créé avec succès!');
                }
            } catch (error) {
                showNotification('❌ Erreur lors du backup');
            }
        }
        
        async function exportData() {
            try {
                const data = await pywebview.api.export_data();
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `study_game_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showNotification('✅ Données exportées!');
            } catch (error) {
                showNotification('❌ Erreur lors de l\'export');
            }
        }
        
        // ACHIEVEMENTS TAB SWITCH
        function switchAchTab(tab) {
            document.querySelectorAll('#achievements-page .tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if (tab === 'achievements') {
                document.getElementById('achievementsTab').style.display = 'block';
                document.getElementById('badgesTab').style.display = 'none';
            } else {
                document.getElementById('achievementsTab').style.display = 'none';
                document.getElementById('badgesTab').style.display = 'block';
            }
        }
        
        // PAGE NAVIGATION
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(pageName + '-page').classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Close mobile menu
            closeMobileMenuOnNav();
            
            if (pageName === 'fiches') {
                backToFicheMatieres();
                document.getElementById('ficheSearch').value = '';
                clearFicheSearch();
            }
        }
        
        // NOTIFICATION
        function showNotification(message, type = 'default') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.remove('success', 'error');
            if (type === 'success') notif.classList.add('success');
            if (type === 'error') notif.classList.add('error');
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
        
        // CONFETTI ANIMATION
        function createConfetti(count = 50) {
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // LEVEL UP ANIMATION
        function showLevelUpAnimation(newLevel) {
            const overlay = document.createElement('div');
            overlay.className = 'level-up-overlay';
            overlay.innerHTML = `
                <div class="level-up-content">
                    <h1>🎉 NIVEAU ${newLevel} 🎉</h1>
                    <p style="font-size: 24px; color: var(--text-secondary); margin-top: 16px;">
                        Félicitations ! Tu continues de progresser !
                    </p>
                </div>
            `;
            document.body.appendChild(overlay);
            
            createConfetti(100);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }, 3000);
        }
        
        // ACHIEVEMENT POPUP
        function showAchievementPopup(title, description) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <h3>🏆 ${title}</h3>
                <p>${description}</p>
            `;
            document.body.appendChild(popup);
            
            createConfetti(30);
            
            setTimeout(() => {
                popup.style.opacity = '0';
                popup.style.transform = 'translateY(100px)';
                setTimeout(() => popup.remove(), 500);
            }, 4000);
        }
        
        // ANIMATED COUNTER
        function animateCounter(element, target, duration = 1000) {
            const start = parseInt(element.textContent) || 0;
            const increment = (target - start) / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current);
            }, 16);
        }
        
        // CREATE FLOATING PARTICLES
        function createFloatingParticles(count = 20) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 5 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                document.body.appendChild(particle);
            }
        }
        
        // RIPPLE EFFECT ON CLICK
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn') || e.target.classList.contains('nav-item')) {
                const ripple = document.createElement('span');
                ripple.style.position = 'absolute';
                ripple.style.borderRadius = '50%';
                ripple.style.background = 'rgba(255, 255, 255, 0.6)';
                ripple.style.width = ripple.style.height = '100px';
                ripple.style.marginLeft = '-50px';
                ripple.style.marginTop = '-50px';
                ripple.style.left = e.clientX + 'px';
                ripple.style.top = e.clientY + 'px';
                ripple.style.animation = 'ripple 0.6s';
                ripple.style.pointerEvents = 'none';
                ripple.style.zIndex = '10000';
                
                document.body.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            }
        });
        
        // SMOOTH SCROLL TO ELEMENT
        function smoothScrollTo(element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // INITIALIZE PARTICLES ON LOAD
        window.addEventListener('load', function() {
            createFloatingParticles(15);
        });
        
        // UPDATE GLOBAL XP BAR
        function updateGlobalXPBar(currentXP, nextLevelXP) {
            const bar = document.getElementById('globalXPProgress');
            if (bar) {
                const percentage = (currentXP / nextLevelXP) * 100;
                bar.style.width = percentage + '%';
            }
        }
    </script>
</body>
</html>
    